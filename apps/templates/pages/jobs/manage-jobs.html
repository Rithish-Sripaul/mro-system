{% extends 'layouts/vertical.html' %} {% block title %}Form Wizard{% endblock title %} {% block extra_css %}

<link rel="stylesheet" href="{{ config.ASSETS_ROOT }}/plugins/dropzone/dropzone.css" type="text/css" />
<link rel="stylesheet" href="{{ config.ASSETS_ROOT }}/plugins/daterangepicker/daterangepicker.css" type="text/css" />
<link rel="stylesheet" href="{{ config.ASSETS_ROOT }}/plugins/choices/choices.min.css" />
<link rel="stylesheet" href="{{ config.ASSETS_ROOT }}/plugins/pickr/classic.min.css" />
<link rel="stylesheet" href="{{ config.ASSETS_ROOT }}/plugins/pickr/monolith.min.css" />
<link rel="stylesheet" href="{{ config.ASSETS_ROOT }}/plugins/pickr/nano.min.css" />
<link href="{{ config.ASSETS_ROOT }}/plugins/quill/quill.core.css" rel="stylesheet" type="text/css" />
<link href="{{ config.ASSETS_ROOT }}/plugins/quill/quill.snow.css" rel="stylesheet" type="text/css" />

<!-- Tagify Plugin CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@yaireo/tagify@4.35.1/dist/tagify.min.css" />

<style>
  /* Add this CSS to a custom stylesheet or within a <style> tag in your extra_css block */
  .tall-input {
    /* Adjust this height (in pixels) until it visually matches the height 
       of your Choices.js multiple-select box. */
    height: 46px !important;
  }

  .choices.is-invalid .choices__inner {
    border-color: #f1556c; /* Bootstrap's danger color */
  }

  /* Add red border to invalid Dropzone container */
  .dropzone.is-invalid {
    border-color: #f1556c; /* Bootstrap's danger color */
  }

  /* Add red border to invalid Tagify container */
  tagify.is-invalid + .tagify {
    border-color: #f1556c;
  }

  .choices.choices.is-invalid {
    margin-bottom: 0px !important;
  }

  .choices.is-valid .choices__inner {
    border-color: #0acf97; /* Bootstrap's success color */
  }

  .choices {
    margin-bottom: 0px !important;
  }

  .was-validated #quill-editor:has(+ #description:invalid) .ql-container {
    border-color: #f1556c !important; /* Bootstrap's danger color */
  }

  /* 1. Default state for the badge */
  .division-badge {
    background-color: #e9ecef;
    color: #495057;
    font-size: 0.8rem; /* This applies the h5 font size */
    font-weight: 600;
    transition: all 0.3s ease-in-out;
    line-height: 1.5; /* Improves vertical alignment */
  }
  /* 2. Hover state with the green glow */
  .division-badge:hover {
    color: #fff;
    font-weight: 700;
    background-color: #198754;
    box-shadow: 0 0 8px #28a745; /* This adds the green glow */
  }
</style>
{% endblock extra_css %} {% block page_content %}

<div class="container-fluid">
  {% set title='Create Job' %} {% set subtitle='Jobs' %} {% include 'partials/page-title.html' %}

  <div class="row justify-content-start">
    <div class="col-xxl-8">
      <div class="card">
        <div class="card-header justify-content-between">
          <h4 class="card-title">Job Creation</h4>
          <span class="badge badge-soft-success badge-label fs-xxs py-1">Exclusive</span>
        </div>
        <div class="card-body">
          <div class="ins-wizard">
            <!-- Navigation Tabs -->

            <!-- Content -->
            <div class="tab-content" data-wizard-content>
              <form id="createJobForm" method="POST" enctype="multipart/form-data" novalidate>
                <!-- Step 1: Job Info -->
                <div class="tab-pane fade show active" id="jobInfo">
                  <div class="row">
                    {# JOB COLOR #}
                    <div class="col-xl-12 mb-3">
                      <div class="mb-2">
                        <h5 class="fw-semibold mb-1">Job Color</h5>
                      </div>
                      <div class="col-lg-6">
                        <div class="classic-colorpicker" id="job_color" data-hidden-input="#job_color_value"></div>
                        <input type="hidden" name="job_color" id="job_color_value" value="#4A81D4" />
                      </div>
                    </div>
                    {# JOB NAME #}
                    <div class="col-xl-12">
                      <div class="mb-3">
                        <label class="form-label">Job Name</label>
                        <input
                          type="text"
                          class="form-control"
                          placeholder="Enter the job name"
                          name="job_name"
                          required
                        />
                        <div class="invalid-feedback">Please provide a Job Name</div>
                      </div>
                    </div>

                    {# DIVISION and COORDINATOR #}
                    <div class="row d-flex mb-3">
                      {# DIVISION #}
                      <div class="col-xl-6 d-flex">
                        <div class="h-100 w-100">
                          <label class="form-label">Division</label>
                          <select
                            class="form-select choices-js-required"
                            id="divisions-multiple-remove-button"
                            data-choices
                            data-choices-removeItem
                            name="divisions"
                            placeholder="Select divisions"
                            data-placeholder="Select divisions"
                            multiple
                            required
                          >
                            {% for division in divisions_list %}
                            <option value="{{ division._id }}">{{ division.name }}</option>
                            {% endfor %}
                          </select>
                          <div class="invalid-feedback">Please select at least one division.</div>
                        </div>
                      </div>
                      {# LEAD BY #}
                      <div class="col-xl-6 d-flex">
                        <div class="h-100 w-100">
                          <label class="form-label">Coordinator</label>
                          <select
                            class="form-select"
                            id="coordinators-multiple-remove-button"
                            data-choices
                            data-choices-removeItem
                            name="coordinators"
                            placeholder="Select Coordinator"
                            data-placeholder="Select Coordinator"
                            multiple
                          >
                            {% for user in user_list %}
                            <option value="{{ user._id }}">{{ user.name }}</option>
                            {% endfor %}
                          </select>
                        </div>
                      </div>
                    </div>
                    {# DESCRIPTION #}
                    <div class="col-xl-12">
                      <div class="mb-3">
                        <label class="form-label">Description</label>
                        <div id="quill-editor" class="quill-editor-required" style="height: 300px"></div>
                        <input type="hidden" name="description" id="description" required />
                        <div class="invalid-feedback">Please provide a job description.</div>
                      </div>
                    </div>
                    <div class="col-xl-12">
                      <div class="mb-3">
                        <label class="form-label">Tags</label>
                        <div>
                          <input
                            id="basicTagify"
                            class="form-control mb-2"
                            data-blacklist=".NET, PHP"
                            name="tags"
                            placeholder="Type in tags and press enter"
                          />
                          <button class="tags--removeAllBtn btn btn-sm btn-soft-danger" type="button">
                            Remove all these tags
                          </button>
                        </div>
                      </div>
                    </div>
                    {# DEADLINES AND SCHEDULES #}
                    <div class="my-3 border-top border-dashed"></div>
                    <h3 class="mb-3">
                      Deadline
                      <small class="text-body-secondary">& Schedules</small>
                    </h3>
                    {# DEADLINE #}
                    <div class="col-xl-6 d-flex">
                      <div class="mb-3 h-100 w-100">
                        <label class="form-label">Completion Date</label>
                        <input
                          type="text"
                          class="form-control date tall-input choices-js-required"
                          id="daterangetime"
                          name="completion_time"
                          data-toggle="date-picker"
                          data-time-picker="true"
                          placeholder="Select the completion date and time"
                          data-locale="{'format': 'MM/DD/YYYY hh:mm A'}"
                          required
                        />
                        <div class="invalid-feedback">Please select a completion date.</div>
                      </div>
                    </div>
                    {# SCHEDULES #} {# SCHEDULES TYPE #}
                    <div class="col-xl-3">
                      <div class="mb-0">
                        <label for="schedule_type" class="form-label">Schedule Type</label>
                        <select
                          class="form-select m-0 pb-0"
                          id="schedule_type"
                          name="schedule_type"
                          data-choices
                          required
                        >
                          <option value="" disabled selected>Select Schedule Type</option>
                          <option value="general_schedule">General Schedule</option>
                          <option value="priority_schedule">Priority Schedule</option>
                        </select>
                        <div class="invalid-feedback">Please select a schedule type.</div>
                      </div>
                    </div>
                    {# SCHEDULES POSITION #}
                    <div class="col-xl-3">
                      <div class="">
                        <label for="schedule_position" class="form-label">Schedule Position</label>
                        <input
                          type="number"
                          class="form-control tall-input"
                          placeholder="Enter the schedule position"
                          id="schedule_position"
                          name="schedule_position"
                          min="1"
                          required
                        />
                        <div class="invalid-feedback">Please provide a valid schedule position</div>
                      </div>
                    </div>
                    <div class="col-xl-9" id="empty_schedule_position"></div>
                    <div class="col-xl-3 mb-1" id="schedule_position_container"></div>
                  </div>

                  <div class="d-flex justify-content-start mt-3">
                    <button type="submit" class="btn btn-primary">Create Job</button>
                  </div>
                </div>
              </form>
              <!-- Step 2: Documents -->
              <div class="tab-pane fade" id="documents">
                <div class="mb-3"></div>
                <div class="d-flex justify-content-between mt-3">
                  <button type="button" class="btn btn-secondary" data-wizard-prev>← Back: Job Info</button>
                  <input type="submit" class="btn btn-success" />
                </div>
              </div>
            </div>
            <!-- tab-content -->
          </div>
          <!-- ins-wizard -->
        </div>
        <!-- end card body-->
      </div>
    </div>

    {# SCHEDULE POSITION TABLE #}
    <div class="col-xxl-4">
      {# General Schedule Jobs #}
      <div data-table data-table-rows-per-page="5" class="card">
        <div class="card-header">
          <h4 class="card-title">General Schedule Jobs</h4>
        </div>

        <div class="card-header border-light justify-content-between">
          <div class="d-flex gap-2">
            <div class="app-search">
              <input data-table-search type="search" class="form-control" placeholder="Search job name..." />
              <i data-lucide="search" class="app-search-icon text-muted"></i>
            </div>
            <button data-table-delete-selected class="btn btn-danger d-none">Delete</button>
          </div>

          <!-- Records Per Page -->
          <div>
            <select data-table-set-rows-per-page class="form-select form-control my-1 my-md-0">
              <option value="2">2</option>
              <option value="5">5</option>
              <option value="10">10</option>
              <option value="15">15</option>
              <option value="20">20</option>
            </select>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-custom table-centered table-select table-hover w-100 mb-0">
            <thead class="bg-light align-middle bg-opacity-25 thead-sm">
              <tr class="text-uppercase fs-xxs">
                <th style="width: 25%">Position</th>

                <th>Job</th>
                <th class="text-center" style="width: 1%">Actions</th>
              </tr>
            </thead>
            <tbody id="general_schedule_tbody">
              {% for job in general_schedule_jobs_list %}
              <tr>
                <td>{{ job.schedule_position }}</td>
                <td>
                  <div class="d-flex">
                    <div>
                      <h5 class="mb-1">
                        <a href="{{ url_for('jobs.job_details', job_id=job._id) }}" class="link-reset">
                          {{ job.job_name }}
                        </a>
                      </h5>
                    </div>
                  </div>
                </td>
                <td>
                  <div class="d-flex justify-content-center gap-1">
                    <a href="#" class="btn btn-light btn-icon btn-sm rounded-circle"><i class="ti ti-eye fs-lg"></i></a>
                  </div>
                </td>
              </tr>

              {% endfor %}
            </tbody>
          </table>
        </div>
        <div class="card-footer border-0">
          <div class="d-flex justify-content-end align-items-center">
            <div data-table-pagination></div>
          </div>
        </div>
      </div>
      <hr class="mb-4 mt-4" />
      {# Priority Schedule Jobs #}
      <div data-table data-table-rows-per-page="5" class="card">
        <div class="card-header">
          <h4 class="card-title">Priority Schedule Jobs</h4>
        </div>

        <div class="card-header border-light justify-content-between">
          <div class="d-flex gap-2">
            <div class="app-search">
              <input data-table-search type="search" class="form-control" placeholder="Search job name..." />
              <i data-lucide="search" class="app-search-icon text-muted"></i>
            </div>
            <button data-table-delete-selected class="btn btn-danger d-none">Delete</button>
          </div>

          <!-- Records Per Page -->
          <div>
            <select data-table-set-rows-per-page class="form-select form-control my-1 my-md-0">
              <option value="5">5</option>
              <option value="10">10</option>
              <option value="15">15</option>
            </select>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-custom table-centered table-select table-hover w-100 mb-0">
            <thead class="bg-light align-middle bg-opacity-25 thead-sm">
              <tr class="text-uppercase fs-xxs">
                <th style="width: 25%">Position</th>

                <th>Job</th>
                <th class="text-center" style="width: 1%">Actions</th>
              </tr>
            </thead>
            <tbody id="priority_schedule_tbody">
              {% for job in priority_schedule_jobs_list %}
              <tr>
                <td>{{ job.schedule_position }}</td>
                <td>
                  <div class="d-flex">
                    <div>
                      <h5 class="mb-1">
                        <a href="{{ url_for('jobs.job_details', job_id=job._id) }}" class="link-reset fw-normal">
                          {{ job.job_name }}
                        </a>
                      </h5>
                    </div>
                  </div>
                </td>
                <td>
                  <div class="d-flex justify-content-center gap-1">
                    <a href="#" class="btn btn-light btn-icon btn-sm rounded-circle"><i class="ti ti-eye fs-lg"></i></a>
                  </div>
                </td>
              </tr>

              {% endfor %}
            </tbody>
          </table>
        </div>
        <div class="card-footer border-0">
          <div class="d-flex justify-content-end align-items-center">
            <div data-table-pagination></div>
          </div>
        </div>
      </div>
    </div>
    <!-- end col-->
  </div>

  {# PAST UPLOADED JOBS #}
  <div class="row">
    <div class="col-12">
      <div data-table data-table-rows-per-page="5" class="card">
        <div class="card-header">
          <h4 class="card-title">Complete Custom Table</h4>
        </div>
        <div class="card-header border-light justify-content-between">
          <div class="d-flex gap-2">
            <div class="app-search">
              <input data-table-search type="search" class="form-control" placeholder="Search product name..." />
              <i data-lucide="search" class="app-search-icon text-muted"></i>
            </div>
            <button data-table-delete-selected class="btn btn-danger d-none">Delete</button>
          </div>

          <div class="d-flex align-items-center gap-2">
            <span class="me-2 fw-semibold">Filter By:</span>

            <!-- Category Filter -->
            <div class="app-search">
              <select data-table-filter="category" class="form-select form-control my-1 my-md-0">
                <option value="All">Category</option>
                <option value="Electronics">Electronics</option>
                <option value="Fashion">Fashion</option>
                <option value="Home">Home</option>
                <option value="Sports">Sports</option>
                <option value="Beauty">Beauty</option>
              </select>
              <i data-lucide="tag" class="app-search-icon text-muted"></i>
            </div>

            <div class="app-search">
              <select data-table-filter="division" class="form-select form-control my-1 my-md-0">
                <option value="All">Division</option>
                {% for division in divisions_list %}
                <option value="{{ division.name }}">{{ division.name }}</option>
                {% endfor %}
              </select>
              <i data-lucide="building" class="app-search-icon text-muted"></i>
            </div>

            <div class="app-search">
              <select data-table-filter="schedule_type" class="form-select form-control my-1 my-md-0">
                <option value="All">Schedule Type</option>
                <option value="Priority">Priority</option>
                <option value="General">General</option>
              </select>
              <i data-lucide="calendar-check" class="app-search-icon text-muted"></i>
            </div>

            <!-- Stock Filter -->
            <div class="app-search">
              <select data-table-filter="status" class="form-select form-control my-1 my-md-0">
                <option value="">Status</option>
                <option value="Published">Published</option>
                <option value="Pending">Pending</option>
                <option value="Out of Stock">Out of Stock</option>
              </select>
              <i data-lucide="loader" class="app-search-icon text-muted"></i>
            </div>

            <div class="app-search">
              <select data-table-range-filter="deadline" class="form-select form-control my-1 my-md-0">
                <option value="All" selected>All Deadlines</option>
                <option value="Today">Today</option>
                <option value="Tomorrow">Tomorrow</option>
                <option value="This Week">This Week</option>
                <option value="Next Week">Next Week</option>
                <option value="This Month">This Month</option>
              </select>
              <i data-lucide="clock-alert" class="app-search-icon text-muted"></i>
            </div>

            <!-- Records Per Page -->
            <div>
              <select data-table-set-rows-per-page class="form-select form-control my-1 my-md-0">
                <option value="5">5</option>
                <option value="10">10</option>
                <option value="15">15</option>
                <option value="20">20</option>
              </select>
            </div>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-custom table-centered table-select table-hover w-100 mb-0">
            <thead class="bg-light align-middle bg-opacity-25 thead-sm">
              <tr class="text-uppercase fs-xxs">
                <th class="ps-3" style="width: 1%">
                  <input
                    data-table-select-all
                    class="form-check-input form-check-input-light fs-14 mt-0"
                    type="checkbox"
                    value="option"
                  />
                </th>
                <th data-table-sort="product">Product</th>
                <th data-table-sort>Created At</th>
                <th data-table-sort="division" data-column="division">Division</th>
                <th data-table-sort data-column="category">Category</th>
                <th data-table-sort>Operations</th>
                <th data-table-sort data-column="schedule_type">Schedule</th>
                <th data-table-sort>Position</th>
                <th data-table-sort data-column="status">Status</th>
                <th data-table-sort data-column="deadline">Deadline</th>
                <th class="text-center" style="width: 1%">Actions</th>
              </tr>
            </thead>
            <tbody>
              <!-- Product Row -->
              {% for job in jobs_list %}
              <tr>
                <td class="ps-3">
                  <input
                    class="form-check-input form-check-input-light fs-14 product-item-check mt-0"
                    type="checkbox"
                    value="option"
                  />
                </td>

                <td>
                  <div class="d-flex">
                    <div class="avatar-md me-3">
                      <div
                        class="rounded"
                        style="width: 100%; height: 100%; background-color: {{ job.job_color }};"
                      ></div>
                    </div>
                    <div class="d-flex flex-column justify-content-center mb-0">
                      <h5 class="mb-0">
                        <a data-sort="product" href="/ecommerce-product-details" class="link-reset">
                          {{ job.job_name }}
                        </a>
                      </h5>
                    </div>
                  </div>
                </td>
                <td>
                  {{ job.created_at.strftime('%d %b, %Y') }}
                  <small class="text-muted">{{ job.created_at.strftime('%I:%M %p') }}</small>
                </td>
                <td
                  data-divisions="{% for division_id in job.divisions %}|{{ divisions_dict[division_id] }}|{% endfor %}"
                >
                  {% for division_id in job.divisions %}
                  <a href="#" class="badge division-badge me-2 px-2">{{ divisions_dict[division_id] }}</a>
                  {% endfor %}
                </td>
                <td>
                  {% for tag in job.tags %}
                  <span class="badge badge-soft-info me-1 fs-xxs">{{ tag }}</span>
                  {% else %}
                  <span class="text-muted fs-xxs">No tags</span>
                  {% endfor %}
                </td>
                <td>
                  <h5 class="fs-base mb-0 fw-medium">10 / 12</h5>
                </td>

                {% if job.schedule_type == "priority_schedule" %}
                <td>Priority</td>
                {% else %}
                <td>General</td>
                {% endif %}

                <td>{{ job.schedule_position }}</td>
                {% if job.status == "pending" %}
                <td><span class="badge badge-soft-warning fs-xxs">Pending</span></td>
                {% else %}
                <td><span class="badge badge-soft-success fs-xxs">Published</span></td>
                {% endif %}

                <td>
                  {{ job.completion_time.strftime('%d %b, %Y') }}
                  <small class="text-muted">{{ job.completion_time.strftime('%I:%M %p') }}</small>
                </td>
                <td>
                  <div class="d-flex justify-content-center gap-1">
                    <a
                      href="{{ url_for('jobs.job_details', job_id=job._id) }}"
                      class="btn btn-light btn-icon btn-sm rounded-circle"
                    >
                      <i class="ti ti-eye fs-lg"></i>
                    </a>
                    <a href="#" class="btn btn-light btn-icon btn-sm rounded-circle">
                      <i class="ti ti-edit fs-lg"></i>
                    </a>
                    <a href="#" data-table-delete-row class="btn btn-danger btn-icon btn-sm rounded-circle">
                      <i class="ti ti-trash fs-lg"></i>
                    </a>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div class="card-footer border-0">
          <div class="d-flex justify-content-between align-items-center">
            <div data-table-pagination-info="products"></div>
            <div data-table-pagination></div>
          </div>
        </div>
      </div>
    </div>
    <!-- end col -->
  </div>

  <!-- end row -->
</div>
<!-- container -->

{% endblock page_content %} {% block extra_javascript %}
<script></script>
{# DROPZONE #}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Initialize Choices.js for select elements
    new Choices("#divisions-multiple-remove-button", {
      removeItemButton: true,
      searchEnabled: true,
      allowHTML: true,
    });
    new Choices("#coordinators-multiple-remove-button", {
      removeItemButton: true,
      searchEnabled: true,
      allowHTML: true,
    });
    new Choices("#schedule_type", {
      searchEnabled: false,
      allowHTML: true,
    });

    // Initialize Tagify for tags input
    var input = document.getElementById("basicTagify");
    if (input) {
      new Tagify(input, {
        whitelist: [], // You can populate this dynamically if needed
        maxTags: 10,
        dropdown: {
          maxItems: 20,
          classname: "tags-look", // custom class for the dropdown
          enabled: 0, // show dropdown immediately on focus
          closeOnSelect: false, // keep dropdown open after selecting a tag
        },
      });
    }

    // Form validation for Quill editor and overall form
    var createJobForm = document.getElementById("createJobForm");
    createJobForm.addEventListener(
      "submit",
      function (event) {
        var descriptionInput = document.getElementById("description");
        var quillEditorDiv = document.getElementById("quill-editor");
        var quillInstance = quillEditorDiv.__quill; // Get instance from the element

        // Always clear custom validity first
        descriptionInput.setCustomValidity("");

        if (quillInstance) {
          // Update hidden input for Quill before validation
          descriptionInput.value = quillInstance.root.innerHTML;

          // Custom validation for Quill editor
          // Check if the editor content is empty (after stripping HTML tags and trimming whitespace)
          const textContent = quillInstance.getText().trim();
          const htmlContent = quillInstance.root.innerHTML.trim();

          // Quill's getText() might return a newline even if empty, so check HTML too
          if (textContent === "" || htmlContent === "<p><br></p>") {
            descriptionInput.setCustomValidity("Please provide a job description.");
          }
        } else {
          // Fallback if Quill instance isn't found (shouldn't happen if form-quilljs.js loads)
          if (descriptionInput.value.trim() === "") {
            descriptionInput.setCustomValidity("Please provide a job description.");
          }
        }

        // Now check overall form validity
        if (!createJobForm.checkValidity()) {
          event.preventDefault();
          event.stopPropagation();
        }

        createJobForm.classList.add("was-validated");
      },
      false
    );
  });
</script>
<script src="{{ config.ASSETS_ROOT }}/plugins/dropzone/dropzone-min.js"></script>

{# PLUGINS #}
<script src="{{ config.ASSETS_ROOT }}/plugins/moment/moment.min.js"></script>
<script src="{{ config.ASSETS_ROOT }}/plugins/daterangepicker/daterangepicker.js"></script>
<script src="{{ config.ASSETS_ROOT }}/plugins/choices/choices.min.js"></script>
<!-- Tagify Plugin Js (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify@4.35.1/dist/tagify.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@yaireo/dragsort@1.3.2/dist/dragsort.min.js"></script>
<script src="{{ config.ASSETS_ROOT }}/plugins/quill/quill.js"></script>
<script src="{{ config.ASSETS_ROOT }}/plugins/pickr/pickr.min.js"></script>
{# CUSTOM JS #} {#
<script src="{{ config.ASSETS_ROOT }}/js/pages/manage-jobs.js"></script>
#}
<script src="{{ config.ASSETS_ROOT }}/js/pages/custom-table.js"></script>
<script src="{{ config.ASSETS_ROOT }}/js/pages/form-colorpickr.js"></script>

{% endblock extra_javascript %}
