{% extends 'layouts/vertical.html' %} {% block title %}Create Operation{% endblock title %} {% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet" />
<link href="{{ config.ASSETS_ROOT }}/plugins/quill/quill.core.css" rel="stylesheet" type="text/css" />
<link rel="stylesheet" href="{{ config.ASSETS_ROOT }}/plugins/daterangepicker/daterangepicker.css" type="text/css" />
<link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet" />
<link href="{{ config.ASSETS_ROOT }}/plugins/quill/quill.snow.css" rel="stylesheet" type="text/css" />
<style>
  /* Tom Select integration styles */
  .ts-dropdown {
    z-index: 1060 !important;
    background-color: #fff !important; /* Force a solid white background */
    border: 1px solid #dee2e6 !important; /* A standard light gray border */
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important; /* Add a shadow for depth */
  }

  .ts-control {
    padding: 0.4375rem 0.875rem; /* Match .form-control padding */
    border: 1px solid #dee2e6 !important; /* A standard light gray border */
  }

  .ts-dropdown .option:hover,
  .ts-dropdown .option.active {
    background-color: #f8f9fa !important; /* A standard light hover color */
    color: #212529 !important; /* Standard dark text color for readability */
  }

  .is-invalid .ts-control {
    border-color: #f1556c;
  }
  .was-validated #quill-editor:has(+ #description:invalid) .ql-container {
    border-color: #f1556c !important; /* Bootstrap's danger color */
  }
</style>
{% endblock extra_css %} {% block page_content %}
<div class="container-fluid">
  {% set title='Create Operation' %} {% set subtitle='Jobs' %} {% include 'partials/page-title.html' %}

  <div class="row justify-content-start">
    <div class="col-xxl-7">
      <div class="card">
        <div class="card-header">
          <h4 class="card-title">
            Create New Operation for Job:
            <a href="{{ url_for('jobs.job_details', job_id=job._id) }}">{{ job.job_name }}</a>
          </h4>
        </div>
        <div class="card-body">
          <form
            id="createOperationForm"
            method="POST"
            action="{{ url_for('jobs.create_operation', job_id=job._id) }}"
            novalidate
          >
            <!-- Operation Info -->
            <div class="row">
              {# OPERATION NAME #}
              <div class="col-xl-12">
                <div class="mb-3">
                  <label class="form-label" for="operation_name">Operation Name</label>
                  <input
                    type="text"
                    class="form-control"
                    id="operation_name"
                    placeholder="Enter the operation name"
                    name="operation_name"
                    required
                  />
                  <div class="invalid-feedback">Please provide an Operation Name.</div>
                </div>
              </div>

              {# DESCRIPTION #}
              <div class="col-xl-12">
                <div class="mb-3">
                  <label class="form-label" for="description">Description</label>
                  <div id="quill-editor" class="quill-editor-required" style="height: 200px"></div>
                  <input type="hidden" name="description" id="description" required />
                  <div class="invalid-feedback">Please provide an operation description.</div>
                </div>
              </div>

              {# ESTIMATED TIME #}
              <div class="col-xl-6">
                <div class="mb-3">
                  <label class="form-label" for="estimated_time">Estimated Time (Hours)</label>
                  <input
                    type="number"
                    class="form-control"
                    id="estimated_time"
                    name="estimated_time"
                    min="0.1"
                    step="0.1"
                    placeholder="e.g., 2.5"
                    required
                  />
                  <div class="invalid-feedback">Please provide a valid estimated time.</div>
                </div>
              </div>

              {# ASSIGNED MACHINE #}
              <div class="col-xl-6">
                <div class="mb-3">
                  <label class="form-label" for="assigned_machine">Assigned Machine</label>
                  <select id="assigned_machine" name="assigned_machine" required>
                    <option value="">Select Machine</option>
                    {% for machine in all_machines %} {% set is_busy = machine._id|string in busy_machine_ids %}
                    <option value="{{ machine._id }}" {% if is_busy %}disabled{% endif %}>
                      {{ machine.machine_name }} {% if machine._id|string in busy_machine_ids %}(In Use){% endif %}
                    </option>
                    {% endfor %}
                  </select>
                  <div class="invalid-feedback">Please select an assigned machine.</div>
                </div>
              </div>

              {# ASSIGNED OPERATORS #}
              <div class="col-xl-12">
                <div class="mb-3">
                  <label class="form-label" for="assigned_operators">Assigned Operators</label>
                  <select id="assigned_operators" name="assigned_operators" multiple required>
                    {% for user in all_users %} {% set is_busy = user._id|string in busy_operator_ids %}
                    <option value="{{ user._id }}" {% if is_busy %}disabled{% endif %}>
                      {{ user.name }} {% if user._id|string in busy_operator_ids %}(In Use){% endif %}
                    </option>
                    {% endfor %}
                  </select>
                  <div class="invalid-feedback">Please select at least one operator.</div>
                </div>
              </div>

              {# RAW MATERIALS REQUIRED #}
              <div class="col-xl-12 mt-3">
                <h5 class="mb-3">Raw Materials Required</h5>
                <div id="materials-container">
                  <!-- Dynamic material rows will be added here -->
                </div>
                <button type="button" id="add-material-row" class="btn btn-sm btn-soft-primary mt-2">
                  <i class="ti ti-plus me-1"></i>
                  Add Material
                </button>
                <input type="hidden" name="materials_data" id="materials_data" value="[]" />
              </div>
            </div>

            <div class="d-flex justify-content-end mt-4">
              <button type="submit" class="btn btn-primary">Create Operation</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <div class="col-xxl-5">
      <div class="card">
        <div class="card-header">
          <h4 class="card-title">Available Inventory</h4>
        </div>
        <div class="card-body">
          <p class="text-muted mb-3">Displays the current quantity on hand for the selected raw materials.</p>
          <div class="table-responsive">
            <table class="table table-sm table-bordered table-nowrap mb-0">
              <thead class="bg-light align-middle bg-opacity-25 thead-sm">
                <tr class="text-uppercase fs-xxs">
                  <th>Material (SKU)</th>
                  <th class="text-end">On Hand</th>
                </tr>
              </thead>
              <tbody id="current-stock-info-body">
                {# Stock info rows will be dynamically added here #}
                <tr>
                  <td colspan="2" class="text-center text-muted">No materials selected.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Reminder Modal (Copied and adapted from raw-material-details.html) -->
<div class="modal fade" id="reminderModal" tabindex="-1" aria-labelledby="reminderModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="reminderModalLabel">Set Procurement Reminder</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="reminderForm" novalidate>
        <div class="modal-body">
          <p class="text-muted">
            Insufficient stock for
            <strong id="reminder-material-name">Material Name</strong>
            . Please set a reminder to order more.
          </p>
          <input type="hidden" id="reminder-material-id" name="material_id" />
          <div class="mb-3">
            <label for="quantity_to_order" class="form-label">Quantity to Order</label>
            <div class="input-group">
              <input
                type="number"
                class="form-control"
                id="quantity_to_order"
                name="quantity_to_order"
                placeholder="e.g., 500"
                required
              />
              <span class="input-group-text" id="reminder-uom">UoM</span>
            </div>
          </div>
          <div class="mb-3">
            <label for="deadline" class="form-label">Order Deadline</label>
            <input
              type="text"
              id="deadline"
              name="deadline"
              class="form-control"
              data-provider="flatpickr"
              data-date-format="Y-m-d"
              placeholder="Select Date"
              required
            />
          </div>
          <div class="mb-3">
            <label for="notes" class="form-label">Notes (Optional)</label>
            <textarea
              class="form-control"
              id="notes"
              name="notes"
              rows="3"
              placeholder="e.g., Check for new suppliers"
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel Operation</button>
          <button type="submit" class="btn btn-primary">Set Reminder & Continue</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock page_content %} {% block extra_javascript %}
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
<script src="{{ config.ASSETS_ROOT }}/plugins/quill/quill.js"></script>
<script src="{{ config.ASSETS_ROOT }}/plugins/moment/moment.min.js"></script>
<script src="{{ config.ASSETS_ROOT }}/plugins/daterangepicker/daterangepicker.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>

<script>
   document.addEventListener('DOMContentLoaded', function() {
     // --- Reminder Modal Setup ---
     const reminderModalEl = document.getElementById('reminderModal');
     const reminderModal = new bootstrap.Modal(reminderModalEl);
     const reminderForm = document.getElementById('reminderForm');
     const reminderMaterialName = document.getElementById('reminder-material-name');
     const reminderMaterialIdInput = document.getElementById('reminder-material-id');
     const reminderUom = document.getElementById('reminder-uom');

     // Initialize the date picker inside the modal
     $('#deadline')
       .daterangepicker({
         singleDatePicker: true,
         autoUpdateInput: false,
         minDate: new Date(),
         locale: {
           format: 'YYYY-MM-DD',
         },
       })
       .on('apply.daterangepicker', function(ev, picker) {
         $(this).val(picker.startDate.format('YYYY-MM-DD'));
       });

     // Initialize Tom Select for static select elements
     new TomSelect('#assigned_machine', { dropdownParent: 'body' });
     new TomSelect('#assigned_operators', {
       plugins: ['remove_button'],
       dropdownParent: 'body',
     });

     // --- Quill Editor Initialization ---
     // This was previously in form-quilljs.js
     var quill = new Quill('#quill-editor', {
       theme: 'snow',
       modules: { toolbar: [[{ font: [] }, { size: [] }], ['bold', 'italic', 'underline', 'strike'], [{ color: [] }, { background: [] }], [{ script: 'super' }, { script: 'sub' }], [{ header: [!1, 1, 2, 3, 4, 5, 6] }, 'blockquote', 'code-block'], [{ list: 'ordered' }, { list: 'bullet' }, { indent: '-1' }, { indent: '+1' }], ['direction', { align: [] }], ['link', 'image', 'video', 'formula'], ['clean']] },
     });
     quill.on('text-change', function() { document.getElementById('description').value = quill.root.innerHTML; });

     // Form validation for Quill editor
     var createOperationForm = document.getElementById('createOperationForm');
     createOperationForm.addEventListener('submit', async function(event) {

       event.preventDefault(); // Always prevent default submission to handle it manually
       // Update hidden input for Quill before validation
       document.getElementById('description').value = quill.root.innerHTML;

       // Custom validation for Quill editor
       var descriptionInput = document.getElementById('description');
       var quillEditorDiv = document.getElementById('quill-editor');
       var quillInstance = quillEditorDiv.__quill; // Get instance from the element
       if (quillInstance) {
         descriptionInput.value = quillInstance.root.innerHTML;

         // Custom validation for Quill editor
         if (quillInstance.getText().trim() === '') {
           descriptionInput.setCustomValidity('Please provide an operation description.');
         }
       }
       if (!createOperationForm.checkValidity()) {
         event.stopPropagation();
         createOperationForm.classList.add('was-validated');
         return; // Stop if form is invalid
       }

       let insufficientStockMaterials = [];
       const materialRows = materialsContainer.querySelectorAll('.row.g-2');

       materialRows.forEach(row => {
         const materialId = row.querySelector('.material-select').value;
         const quantityInput = row.querySelector('.quantity-input');
         const requiredQuantity = parseFloat(quantityInput.value);

         if (materialId && !isNaN(requiredQuantity) && requiredQuantity > 0) {
           const material = allRawMaterials.find(m => m._id === materialId);
           if (material && requiredQuantity > material.current_quantity) {
             insufficientStockMaterials.push({
               id: material._id,
               name: material.material_name,
               uom: material.uom,
             });
           }
         }
       });

       if (insufficientStockMaterials.length > 0) {
         const remindersSet = await processRemindersSequentially(insufficientStockMaterials);
         if (!remindersSet) {
           Swal.fire('Cancelled', 'Operation creation has been cancelled.', 'info');
           return; // Stop if user cancelled the reminder process
         }
       }

       // If all checks pass (including reminders), submit the form
       createOperationForm.submit();
       console.log("Everything is perfect!")

     });

     async function processRemindersSequentially(materials) {
       for (const material of materials) {
         try {
           await showAndProcessReminderModal(material);
         } catch (error) {
           console.log('Reminder process cancelled by user.');
           console.log(error)
           return false; // User cancelled
         }
       }
       return true; // All reminders were set
     }

  function showAndProcessReminderModal(material) {
       return new Promise((resolve, reject) => {
         // Populate modal
         reminderMaterialName.textContent = material.name;
         reminderMaterialIdInput.value = material.id;
         reminderUom.textContent = material.uom;
         reminderForm.reset(); // Clear previous inputs including validation states
         $('#deadline').val(''); // Clear date picker specifically

         let isResolved = false; // Flag for successful submission
         let submitButton = reminderForm.querySelector('button[type="submit"]');
         const originalButtonText = "Set Reminder & Continue"; // Store original text

         // *** Reset button state BEFORE showing ***
         submitButton.disabled = false;
         submitButton.innerHTML = originalButtonText;
         reminderForm.classList.remove('was-validated'); // Reset validation state visually

         // --- Define Handlers ---
         const handleSubmit = (e) => {
           e.preventDefault();
           if (!reminderForm.checkValidity()) {
               reminderForm.classList.add('was-validated');
               return;
           }
           // Intentionally do not remove 'was-validated' on success yet

           isResolved = true; // Mark intent to resolve
           const formData = new FormData(reminderForm);
           const url = `/inventory/raw-material/${material.id}/set-reminder`;

           submitButton.disabled = true;
           submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Setting...';

           fetch(url, { method: 'POST', body: formData })
             .then(response => {
                 if (!response.ok) {
                     return response.json().then(err => { throw new Error(err.error || 'Server error'); });
                 }
                 return response.json();
             })
             .then(data => {
               if (data.success) {
                 reminderModal.hide(); // Let hidden event resolve
               } else {
                 isResolved = false; // Reset flag on failure
                 Swal.fire('Error', data.error || 'Could not set reminder.', 'error');
                  // Re-enable button immediately on logical failure
                  submitButton.disabled = false;
                  submitButton.innerHTML = originalButtonText;
               }
             })
             .catch(error => {
               isResolved = false; // Reset flag on failure
               console.error('Reminder Fetch Error:', error);
               Swal.fire('Error', error.message || 'An unexpected error occurred.', 'error');
                // Re-enable button immediately on fetch/network failure
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonText;
             });
             // Removed finally block here - rely on error handlers and hidden event
         };

         const onModalHidden = () => {
           // *** CRITICAL: Remove listeners AFTER hide completes ***
           reminderForm.removeEventListener('submit', handleSubmit);

           // Resolve or reject based on the final state of the flag
           if (isResolved) {
             resolve();
           } else {
             reject(new Error('Modal closed or cancelled by user'));
           }
         };

         // --- Add Listeners ---
         reminderForm.addEventListener('submit', handleSubmit);
         // Use { once: true } for the hidden event listener
         reminderModalEl.addEventListener('hidden.bs.modal', onModalHidden, { once: true });

         // --- Show Modal ---
         reminderModal.show();
       });
     }
     // --- Dynamic Raw Materials Section ---
     var materialsContainer = document.getElementById('materials-container');
     var addMaterialRowBtn = document.getElementById('add-material-row');
     var materialsDataInput = document.getElementById('materials_data');
     var allRawMaterials = {{ all_raw_materials_json | safe }}; // Raw materials from Flask
     const currentStockInfoBody = document.getElementById('current-stock-info-body');

     let materialRowCounter = 0;

     function addMaterialRow(material = null) {
       materialRowCounter++;
       var rowId = `material-row-${materialRowCounter}`;

       var newRow = document.createElement('div');
       newRow.className = 'row g-2 mb-2 align-items-end';
       newRow.id = rowId;
       newRow.innerHTML = `
         <div class="col-md-6">
           ${materialRowCounter > 1 ? `<label class="form-label visually-hidden" for="material-select-${materialRowCounter}">Material</label>` : `<label class="form-label" for="material-select-${materialRowCounter}">Material</label>`}
           <select class="form-select material-select" id="material-select-${materialRowCounter}" required>
             <option value="">Search material...</option>
             ${allRawMaterials.map(mat => `<option value="${mat._id}" data-uom="${mat.uom}">${mat.material_name} (${mat.sku})</option>`).join('')}
           </select>
           <div class="invalid-feedback">Please select a material.</div>
         </div>
         <div class="col-md-3">
           ${materialRowCounter > 1 ? `<label class="form-label visually-hidden" for="quantity-input-${materialRowCounter}">Quantity</label>` : `<label class="form-label" for="quantity-input-${materialRowCounter}">Quantity</label>`}
           <input type="number" class="form-control quantity-input" id="quantity-input-${materialRowCounter}" min="0.01" step="0.01" placeholder="Quantity" required>
           <div class="invalid-feedback">Please enter a valid quantity.</div>
         </div>
         <div class="col-md-2">
           ${materialRowCounter > 1 ? `<label class="form-label visually-hidden" for="uom-display-${materialRowCounter}">UoM</label>` : `<label class="form-label" for="uom-display-${materialRowCounter}">UoM</label>`}
           <input type="text" class="form-control uom-display" id="uom-display-${materialRowCounter}" placeholder="UoM" readonly>
         </div>
         <div class="col-md-1">
           <button type="button" class="btn btn-danger btn-icon remove-material-row" data-row-id="${rowId}">
             <i class="ti ti-trash"></i>
           </button>
         </div>
       `;
       materialsContainer.appendChild(newRow);

       // Initialize Tom Select for the new select element
       var tomSelect = new TomSelect(newRow.querySelector('.material-select'), {
         dropdownParent: 'body',
       });

       // Set initial values if editing
       if (material) {
         tomSelect.setValue(material.material_id);
         newRow.querySelector('.quantity-input').value = material.quantity;
         newRow.querySelector('.uom-display').value = material.uom || '';
       }

       // Event listener for material selection change to update UoM
       tomSelect.on('change', function(value) {
         var selectedOption = value;
         var uomInput = newRow.querySelector('.uom-display');
         if (selectedOption) {
           // Find the selected material in allRawMaterials to get its UoM
           const selectedMaterial = allRawMaterials.find(mat => mat._id === selectedOption);
           if (selectedMaterial && selectedMaterial.uom) {
             uomInput.value = selectedMaterial.uom;
           } else {
             uomInput.value = '';
           }
         } else {
           uomInput.value = '';
         }
         updateMaterialsData();
         updateStockInfoCard();
       });

       // Event listeners for quantity input change
       newRow.querySelector('.quantity-input').addEventListener('input', () => {
         updateMaterialsData();
         updateStockInfoCard();
       });

       updateMaterialsData(); // Update hidden input after adding a row
       updateStockInfoCard();
     }

     function updateMaterialsData() {
       var materials = [];
       materialsContainer.querySelectorAll('.row.g-2').forEach(function(row) {
         var materialId = row.querySelector('.material-select').value;
         var quantity = row.querySelector('.quantity-input').value;
         var uom = row.querySelector('.uom-display').value;

         if (materialId && quantity) {
           materials.push({
             material_id: materialId,
             quantity: parseFloat(quantity),
             uom: uom
           });
         }
       });
       materialsDataInput.value = JSON.stringify(materials);
     }

     addMaterialRowBtn.addEventListener('click', function() {
       addMaterialRow();
     });

     const updateStockInfoCard = () => {
       currentStockInfoBody.innerHTML = ''; // Clear previous entries
       const selectedMaterialIds = new Set();

       materialsContainer.querySelectorAll('.row.g-2').forEach(function(row) {
         const materialId = row.querySelector('.material-select').value;
         if (materialId && !selectedMaterialIds.has(materialId)) {
           selectedMaterialIds.add(materialId);
           const material = allRawMaterials.find(m => m._id === materialId);

           if (material) {
             const stockRow = document.createElement('tr');
             stockRow.innerHTML = `
               <td>${material.material_name} (${material.sku})</td>
               <td class="text-end">${material.current_quantity} ${material.uom}</td>
             `;
             currentStockInfoBody.appendChild(stockRow);
           }
         }
       });

       if (selectedMaterialIds.size === 0) {
         const noMaterialRow = document.createElement('tr');
         noMaterialRow.innerHTML = `<td colspan="2" class="text-center text-muted">No materials selected.</td>`;
         currentStockInfoBody.appendChild(noMaterialRow);
       }
     };

     // Add at least one material row by default
     if (materialsContainer.children.length === 0) {
       addMaterialRow();
     }
   });
</script>
{% endblock extra_javascript %}
