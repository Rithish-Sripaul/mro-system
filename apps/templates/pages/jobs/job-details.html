?{% extends 'layouts/vertical.html' %} {% block title %}Job Details{% endblock title %} {% block extra_css %}
<style>
  /* 1. Default state for the badge */
  .division-badge {
    background-color: #e9ecef;
    color: #495057;
    font-size: 0.8rem;
    /* This applies the h5 font size */
    font-weight: 600;
    transition: all 0.3s ease-in-out;
    line-height: 1.5;
    /* Improves vertical alignment */
  }

  /* 2. Hover state with the green glow */
  .division-badge:hover {
    color: #fff;
    font-weight: 700;
    background-color: #198754;
    box-shadow: 0 0 8px #28a745;
    /* This adds the green glow */
  }
</style>
{% endblock extra_css %} {% block page_content %}

<div class="container-fluid">
  {% set title='Job Overview' %} {% set subtitle='Jobs' %} {% include 'partials/page-title.html' %}

  <div class="row justify-content-center">
    <div class="col-xxl-10">
      <div class="row g-0">
        <!-- Project Main Details -->
        <div class="col-xl-9">
          <div class="card card-h-100 rounded-0 rounded-start">
            <div class="card-header align-items-start p-4">
              <div class="avatar-xxl me-3">
                <span class="avatar-title text-bg-light rounded">
                  <div class="rounded" style="width: 100%; height: 100%; background-color: {{ job.job_color }};"></div>
                </span>
              </div>
              <div>
                <h3 class="mb-1 d-flex fs-xl align-items-center">{{ job.job_name }}</h3>
                <p class="text-muted mb-2 fs-xxs">Updated 5 minutes ago</p>
                <span class="badge badge-soft-success fs-xxs badge-label">In Progress</span>
              </div>
              <div class="ms-auto d-flex gap-2">
                <a href="{{ url_for('jobs.create_operation', job_id=job._id) }}" class="btn btn-primary">
                  <i class="ti ti-plus me-1"></i>
                  Add Operation
                </a>
                <a href="javascript: void(0);" class="btn btn-light">
                  <i class="ti ti-pencil me-1"></i>
                  Edit
                </a>
              </div>
            </div>
            <div class="card-body px-4">
              <div class="mb-4">
                <h5 class="fs-base mb-2">Job Description:</h5>
                {{ job.description | safe }}
              </div>
              <div class="row mb-4">
                <div class="col-md-4 col-xl-3">
                  <h6 class="mb-1 text-muted text-uppercase">Created Date:</h6>
                  <p class="fw-medium mb-0">{{ job.start_time.strftime('%B %d, %Y') }}</p>
                </div>
                <div class="col-md-4 col-xl-3">
                  <h6 class="mb-1 text-muted text-uppercase">Deadline:</h6>
                  <p class="fw-medium mb-0">{{ job.completion_time.strftime('%B %d, %Y') }}</p>
                </div>
                <div class="col-md-4 col-xl-3">
                  <h6 class="mb-1 text-muted text-uppercase">Division:</h6>
                  <div>
                    {% for division_id in job.divisions %}
                    <a href="#" class="badge text-bg-light text-decoration-none me-1 mb-1">
                      {{ divisions_dict[division_id] }}
                    </a>
                    {% endfor %}
                  </div>
                </div>
                <div class="col-md-4 col-xl-3">
                  <h6 class="mb-1 text-muted text-uppercase">Schedule and Position:</h6>
                  {% if job.schedule_type == "priority_schedule" %}
                  <p class="fw-medium mb-0">Priority Schedule - {{ job.schedule_position }}</p>
                  {% else %}
                  <p class="fw-medium mb-0">General Schedule - {{ job.schedule_position }}</p>
                  {% endif %}
                </div>

                <div class="col-md-4 col-xl-12 mt-2">
                  <h6 class="mb-1 text-muted text-uppercase">Tags:</h6>
                  {% if job.tags == [] %}
                  <span class="text-muted">No tags assigned</span>
                  {% else %}

                  <div class="d-flex flex-wrap">
                    {% for tag in job.tags %}
                    <a href="#" class="badge division-badge me-2 px-2">{{ tag }}</a>
                    {% endfor %}
                  </div>
                  {% endif %}
                </div>
              </div>

              <!-- Tabs -->
              <ul class="nav nav-tabs nav-bordered mb-3" role="tablist">
                <li class="nav-item">
                  <a class="nav-link active" data-bs-toggle="tab" href="#comments" role="tab">
                    <i class="ti ti-message-circle fs-lg me-md-1 align-middle"></i>
                    <span class="d-none d-md-inline-block align-middle">Comments</span>
                  </a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" data-bs-toggle="tab" href="#tasks" role="tab">
                    <i class="ti ti-list-check fs-lg me-md-1 align-middle"></i>
                    <span class="d-none d-md-inline-block align-middle">Operations</span>
                  </a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" data-bs-toggle="tab" href="#activity" role="tab">
                    <i class="ti ti-activity fs-lg me-md-1 align-middle"></i>
                    <span class="d-none d-md-inline-block align-middle">Activity</span>
                  </a>
                </li>
              </ul>
              <div class="tab-content">
                <div class="tab-pane fade active show" id="comments" role="tabpanel">
                  <form id="comment-form" action="#" class="mb-3">
                    <div class="mb-3">
                      <textarea
                        class="form-control"
                        id="comment-textarea"
                        rows="4"
                        placeholder="Enter your messages..."
                      ></textarea>
                    </div>
                    <div class="text-end">
                      <button type="submit" class="btn btn-secondary btn-sm">
                        Comment
                        <i class="ti ti-send-2 align-baseline ms-1"></i>
                      </button>
                    </div>
                  </form>

                  <h4 class="mb-3 fs-md">
                    Comments (
                    <span id="comment-count">0</span>
                    )
                  </h4>

                  <div id="comments-list-container"></div>

                  <div id="comments-footer" class="mt-3" style="display: none">
                    <button id="load-more-comments" class="btn btn-light w-100">Load More Comments</button>
                  </div>
                  <div id="comments-loading" class="text-center mt-3" style="display: none">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                  </div>
                </div>

                <div class="tab-pane fade" id="tasks" role="tabpanel">
                  {% if operations %} {% for operation in operations %}
                  <div class="card mb-1">
                    <div class="card-body p-2">
                      <div class="row g-3 align-items-center justify-content-between">
                        <!-- Left side: Checkbox, Operation Name, and Machine -->
                        <div class="col-md-6">
                          <div class="d-flex align-items-center gap-2">
                            <input
                              type="checkbox"
                              class="form-check-input rounded-circle mt-0 fs-xl"
                              id="task-{{ operation._id }}"
                            />
                            <div>
                              <a
                                href="#!"
                                data-bs-toggle="offcanvas"
                                role="button"
                                class="link-reset fw-semibold fs-base"
                              >
                                {{ operation.operation_name }}
                              </a>
                              <p class="text-muted fs-sm mb-0">
                                <i class="ti ti-settings-cog me-1"></i>
                                <a href="#" class="me-2">{{ operation.machine_name }}</a>
                                <i class="ti ti-clock-hour-8 me-1"></i>
                                <a href="#">{{ operation.estimated_time_display }}</a>
                              </p>
                            </div>
                          </div>
                        </div>
                        <!-- Right side: Operator, Status, and metadata -->
                        <div class="col-md-6">
                          <div class="d-flex align-items-center gap-3 justify-content-md-end">
                            <!-- Assigned Operators -->
                            <div class="avatar-group avatar-group-sm">
                              {% for operator in operation.operators %}
                              <div class="avatar-group-item">
                                <div class="avatar">
                                  <img
                                    src="{{ config.ASSETS_ROOT }}/images/users/user-10.jpg"
                                    alt="${comment.username}"
                                    class="avatar-sm rounded-circle shadow-sm"
                                  />
                                </div>
                              </div>
                              {% else %}
                              <div class="avatar-group-item">
                                <div class="avatar">
                                  <span class="avatar-title rounded-circle bg-light text-muted" title="No operators">
                                    <i class="ti ti-user-off fs-sm"></i>
                                  </span>
                                </div>
                              </div>
                              {% endfor %}
                            </div>

                            <div class="flex-shrink-0">
                              {% set status_map = { 'pending': {'class': 'badge-soft-warning', 'text': 'Pending'},
                              'in_progress': {'class': 'badge-soft-info', 'text': 'In Progress'}, 'suspended': {'class':
                              'badge-soft-danger', 'text': 'Suspended'}, 'completed': {'class': 'badge-soft-success',
                              'text': 'Completed'}, 'at_risk': {'class': 'badge-soft-danger', 'text': 'At Risk'} } %} {%
                              set op_status = status_map.get(operation.status, {'class': 'badge-soft-secondary', 'text':
                              operation.status|capitalize}) %}
                              <span class="badge {{ op_status.class }} badge-label">{{ op_status.text }}</span>
                            </div>

                            <div class="dropdown">
                              <a href="#" class="btn btn-sm btn-icon btn-ghost-secondary" data-bs-toggle="dropdown">
                                <i class="ti ti-dots-vertical fs-base"></i>
                              </a>
                              <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                  <a class="dropdown-item" href="#">
                                    <i class="ti ti-edit me-2"></i>
                                    Edit
                                  </a>
                                </li>
                                <li>
                                  <form
                                    action="{{ url_for('jobs.delete_operation', operation_id=operation._id) }}"
                                    method="POST"
                                    onsubmit="return confirm('Are you sure you want to delete this operation? This will return its materials to stock.');"
                                  >
                                    <button type="submit" class="dropdown-item text-danger">
                                      <i class="ti ti-trash me-2"></i>
                                      Delete
                                    </button>
                                  </form>
                                </li>
                              </ul>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  {% endfor %} {% else %}
                  <div class="text-center py-4">
                    <p class="text-muted">No operations have been added to this job yet.</p>
                    <a href="{{ url_for('jobs.create_operation', job_id=job._id) }}" class="btn btn-primary">
                      <i class="ti ti-plus me-1"></i>
                      Add First Operation
                    </a>
                  </div>
                  {% endif %}
                </div>

                <div class="tab-pane fade" id="activity" role="tabpanel">
                  <div class="d-flex gap-1 border-bottom border-dashed pb-3">
                    <div class="me-2 flex-shrink-0">
                      <img
                        src="{{ config.ASSETS_ROOT }}/images/users/user-1.jpg"
                        class="avatar-md rounded-circle"
                        alt=""
                      />
                    </div>
                    <div class="flex-grow-1 text-muted">
                      <span class="fw-medium text-body">Daniel Martinez</span>
                      uploaded a revised contract file.
                      <p class="fs-xs mb-0 text-body-secondary">Today 10:15 am - 24 Apr, 2025</p>
                    </div>
                    <p class="fs-xs text-body-secondary">5m ago</p>
                  </div>

                  <div class="d-flex gap-1 border-bottom border-dashed py-3">
                    <div class="me-2 flex-shrink-0">
                      <img
                        src="{{ config.ASSETS_ROOT }}/images/users/user-2.jpg"
                        class="avatar-md rounded-circle"
                        alt=""
                      />
                    </div>
                    <div class="flex-grow-1 text-muted">
                      <span class="fw-medium text-body">Nina Patel</span>
                      commented on your design update.
                      <p class="fs-xs mb-0 text-body-secondary">Today 8:00 am - 24 Apr, 2025</p>
                    </div>
                    <p class="fs-xs text-body-secondary">2h ago</p>
                  </div>

                  <div class="d-flex gap-1 border-bottom border-dashed py-3">
                    <div class="me-2 flex-shrink-0">
                      <img
                        src="{{ config.ASSETS_ROOT }}/images/users/user-3.jpg"
                        class="avatar-md rounded-circle"
                        alt=""
                      />
                    </div>
                    <div class="flex-grow-1 text-muted">
                      <span class="fw-medium text-body">Jason Lee</span>
                      completed the feedback review.
                      <p class="fs-xs mb-0 text-body-secondary">Yesterday 6:10 pm - 23 Apr, 2025</p>
                    </div>
                    <p class="fs-xs text-body-secondary">16h ago</p>
                  </div>

                  <div class="d-flex gap-1 border-bottom border-dashed py-3">
                    <div class="me-2 flex-shrink-0">
                      <img
                        src="{{ config.ASSETS_ROOT }}/images/users/user-4.jpg"
                        class="avatar-md rounded-circle"
                        alt=""
                      />
                    </div>
                    <div class="flex-grow-1 text-muted">
                      <span class="fw-medium text-body">Emma Davis</span>
                      shared a link in the marketing group chat.
                      <p class="fs-xs mb-2 text-body-secondary">Yesterday 3:25 pm - 23 Apr, 2025</p>
                      <a href="#!" class="btn btn-default border px-1 py-0">
                        <i class="ti ti-link me-1"></i>
                        View
                      </a>
                    </div>
                    <p class="fs-xs text-body-secondary">19h ago</p>
                  </div>

                  <div class="d-flex gap-1 border-bottom border-dashed py-3">
                    <div class="me-2 flex-shrink-0">
                      <img
                        src="{{ config.ASSETS_ROOT }}/images/users/user-5.jpg"
                        class="avatar-md rounded-circle"
                        alt=""
                      />
                    </div>
                    <div class="flex-grow-1 text-muted position-relative">
                      <span class="fw-medium text-body">Leo Zhang</span>
                      sent you a private message.
                      <p class="fs-xs text-body-secondary">2 days ago 11:45 am - 22 Apr, 2025</p>

                      <div class="py-2 px-3 bg-light bg-opacity-50">
                        "Let’s sync up on the product roadmap tomorrow afternoon, does 2 PM work for you?"
                      </div>
                    </div>
                    <p class="fs-xs flex-shrink-0 text-body-secondary">30h ago</p>
                  </div>

                  <div class="d-flex align-items-center justify-content-center gap-2 p-3">
                    <strong>Loading...</strong>
                    <div class="spinner-border spinner-border-sm text-danger" role="status" aria-hidden="true"></div>
                  </div>
                </div>
              </div>
            </div>
            <!-- end card-body -->
          </div>
          <!-- end card -->
        </div>
        <!-- end col-xl-9 -->

        <!-- Team Sidebar -->
        <div class="col-xl-3">
          <div class="card card-h-100 rounded-0 rounded-end">
            <div class="card-body p-0">
              <div class="p-3 border-bottom border-dashed">
                <h5 class="mb-2">Status</h5>
                <div class="app-search">
                  <select class="form-select form-control my-1 my-md-0">
                    <option>Status</option>
                    <option selected value="On Track">On Track</option>
                    <option value="Delayed">Delayed</option>
                    <option value="At Risk">At Risk</option>
                    <option value="Completed">Completed</option>
                  </select>
                  <i data-lucide="calendar-clock" class="app-search-icon text-muted"></i>
                </div>
              </div>

              <div class="p-3 border-bottom border-dashed">
                <div class="d-flex mb-3 justify-content-between align-items-center">
                  <h5 class="mb-0">Team Members:</h5>
                  <a href="javascript: void(0);" class="btn btn-light btn-sm btn-icon rounded-circle">
                    <i class="ti ti-plus"></i>
                  </a>
                </div>
                <div id="team-members-list">
                  <div class="text-center py-2 text-muted" id="team-loading-placeholder">Loading team...</div>
                </div>

                <!-- End -->
              </div>
              <div class="px-3 pt-3 border-bottom border-dashed">
                <div class="d-flex mb-3 justify-content-between align-items-center">
                  <h5 class="mb-0">Files:</h5>
                  <input type="file" id="job-file-input" multiple style="display: none" />
                  <button
                    type="button"
                    id="add-file-btn"
                    class="btn btn-light btn-sm btn-icon rounded-circle"
                    title="Upload Files"
                  >
                    <i class="ti ti-plus"></i>
                  </button>
                </div>

                <div id="job-files-list">
                  <div class="text-center py-2 text-muted" id="files-loading-placeholder">Loading files...</div>
                </div>

                <div id="file-upload-status" class="mt-2" style="display: none">
                  <div class="progress progress-sm">
                    <div
                      id="file-upload-progress"
                      class="progress-bar"
                      role="progressbar"
                      style="width: 0%"
                      aria-valuenow="0"
                      aria-valuemin="0"
                      aria-valuemax="100"
                    ></div>
                  </div>
                  <small id="file-upload-message" class="text-muted"></small>
                </div>
              </div>
            </div>
            <!-- end card-body -->
          </div>
          <!-- end card -->
        </div>
        <!-- end col-xl-3 -->
      </div>
      <!-- end row -->
    </div>
    <!-- end col-xxl-10 -->
  </div>
  <!-- end row -->
</div>
<!-- container -->

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // --- 1. SELECTORS & STATE ---
    const commentForm = document.getElementById("comment-form");
    const commentTextarea = document.getElementById("comment-textarea");
    const commentsListContainer = document.getElementById("comments-list-container");
    const commentCountSpan = document.getElementById("comment-count");
    const loadMoreButton = document.getElementById("load-more-comments");
    const commentsFooter = document.getElementById("comments-footer");
    const commentsLoading = document.getElementById("comments-loading");

    const teamMembersListContainer = document.getElementById("team-members-list");
    const teamLoadingPlaceholder = document.getElementById("team-loading-placeholder");
    // const addTeamMemberBtn = document.getElementById('add-team-member-btn'); // For later use

    // Selectors for file uploads
    const jobFilesListContainer = document.getElementById("job-files-list");
    const filesLoadingPlaceholder = document.getElementById("files-loading-placeholder");
    const addFileBtn = document.getElementById("add-file-btn");
    const jobFileInput = document.getElementById("job-file-input");
    const fileUploadStatusDiv = document.getElementById("file-upload-status");
    const fileUploadProgressBar = document.getElementById("file-upload-progress");
    const fileUploadMessage = document.getElementById("file-upload-message");

    const jobId = "{{ job._id | string }}";

    // --- Add state for pagination ---
    let currentPage = 1;
    let isLoading = false;

    // --- 2. CORE FUNCTIONS ---

    /**
     * Fetches comments for a specific page and renders them.
     * @param {number} page - The page number to fetch.
     * @param {boolean} append - If true, appends comments. If false, replaces.
     */
    async function fetchAndRenderComments(page = 1, append = false) {
      if (isLoading) return; // Prevent multiple simultaneous loads
      isLoading = true;

      // Show loading spinner
      if (append) {
        commentsFooter.style.display = "none"; // Hide button while loading
        commentsLoading.style.display = "block";
      } else {
        commentsListContainer.innerHTML = ""; // Clear old comments
        commentsLoading.style.display = "block";
      }

      try {
        const response = await fetch(`/jobs/${jobId}/comments?page=${page}&limit=5`);
        if (!response.ok) throw new Error("Failed to fetch comments");

        const data = await response.json();
        const comments = data.comments; // This is now a pre-built tree
        const pagination = data.pagination;

        // Update total comment count (from all pages)
        commentCountSpan.textContent = pagination.total_comments;

        // Render the tree
        if (comments.length === 0 && page === 1) {
          commentsListContainer.innerHTML = '<p class="text-muted">No comments yet. Be the first to comment!</p>';
        } else {
          comments.forEach((comment) => {
            // createCommentHTML is now recursive
            const commentHTML = createCommentHTML(comment);
            if (append) {
              commentsListContainer.insertAdjacentHTML("beforeend", commentHTML);
            } else {
              commentsListContainer.innerHTML += commentHTML;
            }
          });
        }

        // Handle "Load More" button visibility
        if (pagination.has_more) {
          commentsFooter.style.display = "block";
          currentPage = page; // Update current page state
        } else {
          commentsFooter.style.display = "none";
        }
      } catch (error) {
        console.error("Error fetching comments:", error);
        commentsListContainer.innerHTML = '<p class="text-danger">Could not load comments.</p>';
      } finally {
        isLoading = false;
        commentsLoading.style.display = "none"; // Hide spinner
      }
    }

    /**
     * Posts a new comment or reply
     */
    async function postComment(text, parentId = null) {
      try {
        const response = await fetch(`/jobs/${jobId}/comments`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            text: text,
            parent_id: parentId,
          }),
        });

        if (!response.ok) {
          throw new Error("Failed to post comment");
        }

        // --- MODIFICATION ---
        // Success! Clear the main textarea and re-fetch *from page 1*
        commentTextarea.value = "";
        currentPage = 1; // Reset to page 1
        await fetchAndRenderComments(1, false); // Fetch and *replace*
        // --- END MODIFICATION ---
      } catch (error) {
        console.error("Error posting comment:", error);
        alert("There was an error posting your comment.");
      }
    }

    /**
     * The buildCommentTree function is NO LONGER NEEDED here.
     * The backend is doing the tree building.
     */

    /**
     * Recursively creates the HTML for a comment and its replies
     * This function is now RECURSIVE.
     */
    function createCommentHTML(comment) {
      // Use $date for dates coming from json_util
      const date = new Date(comment.timestamp.$date);
      const formattedDate = date.toLocaleString("en-US", {
        month: "short",
        day: "numeric",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit",
      });

      // --- RECURSIVE PART ---
      // Generate HTML for all replies recursively
      let repliesHTML = "";
      if (comment.replies && comment.replies.length > 0) {
        repliesHTML = `
          <div class="mt-4">
            ${comment.replies.map(createCommentHTML).join("")}
          </div>
        `;
      }
      // --- END RECURSIVE PART ---

      // Use $oid for IDs coming from json_util
      const commentId = comment._id.$oid;

      return `
        <div class="d-flex mb-2 border border-dashed rounded p-3">
          <div class="flex-shrink-0">
            <img src="{{ config.ASSETS_ROOT }}/images/users/user-10.jpg" alt="${comment.username}" class="avatar-sm rounded-circle shadow-sm" />
          </div>
          <div class="flex-grow-1 ms-2">
            <h5 class="mb-1">
              ${comment.username}
              <small class="text-muted">${formattedDate}</small>
            </h5>
            <p class="mb-2">${comment.text}</p>
            <a href="javascript:void(0);" class="badge bg-light text-muted d-inline-flex align-items-center gap-1 reply-btn" data-comment-id="${commentId}">
              <i class="ti ti-arrow-back-up fs-lg"></i>
              Reply
            </a>
            
            <div class="reply-form-container mt-3"></div>
            
            ${repliesHTML} </div>
        </div>
      `;
    }

    /**
     * Shows a temporary reply form under a parent comment
     */
    function showReplyForm(parentId, parentElement) {
      // Remove any existing reply forms
      const existingForm = document.getElementById("temp-reply-form");
      if (existingForm) {
        existingForm.remove();
      }

      // Create the new form
      const formHTML = `
        <form id="temp-reply-form" class="mt-3">
          <div class="mb-2">
            <textarea class="form-control" rows="3" placeholder="Write a reply..."></textarea>
          </div>
          <div class="text-end">
            <button type="button" class="btn btn-light btn-sm cancel-reply">Cancel</button>
            <button type="submit" class="btn btn-secondary btn-sm">Submit Reply</button>
          </div>
        </form>
      `;

      // Find the reply-form-container *within* the parent element
      const replyContainer = parentElement.querySelector(".reply-form-container");
      replyContainer.innerHTML = formHTML;

      const tempForm = document.getElementById("temp-reply-form");
      const tempTextarea = tempForm.querySelector("textarea");
      tempTextarea.focus();

      // Handle submission
      tempForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const replyText = tempTextarea.value.trim();
        if (replyText) {
          // We don't need to remove the form, posting re-fetches everything
          await postComment(replyText, parentId);
        }
      });

      // Handle cancel
      tempForm.querySelector(".cancel-reply").addEventListener("click", () => {
        replyContainer.innerHTML = ""; // Just clear the container
      });
    }

    // --- 3. EVENT LISTENERS ---

    // Handle top-level comment form submission
    commentForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const text = commentTextarea.value.trim();
      if (text) {
        await postComment(text, null);
      }
    });

    // Handle "Reply" button clicks using event delegation
    commentsListContainer.addEventListener("click", (e) => {
      const replyButton = e.target.closest(".reply-btn");
      if (replyButton) {
        e.preventDefault();
        const parentId = replyButton.dataset.commentId;
        const parentCommentBody = replyButton.closest(".flex-grow-1");
        showReplyForm(parentId, parentCommentBody);
      }
    });

    // --- NEW: Add click listener for "Load More" button ---
    loadMoreButton.addEventListener("click", () => {
      fetchAndRenderComments(currentPage + 1, true); // Fetch next page and append
    });

    async function fetchAndRenderTeam() {
      try {
        const response = await fetch(`/jobs/${jobId}/team`); // Call the new API endpoint
        if (!response.ok) throw new Error("Failed to fetch team members");

        const teamMembers = await response.json();

        // Clear the loading placeholder
        teamMembersListContainer.innerHTML = "";

        if (teamMembers.length === 0) {
          teamMembersListContainer.innerHTML = '<p class="text-muted fs-xxs text-center py-2">No members assigned.</p>';
        } else {
          teamMembers.forEach((member) => {
            teamMembersListContainer.innerHTML += createTeamMemberHTML(member);
          });
        }
      } catch (error) {
        console.error("Error fetching team members:", error);
        teamMembersListContainer.innerHTML = '<p class="text-danger fs-xxs text-center py-2">Could not load team.</p>';
      }
    }

    /**
     * Creates the HTML for a single team member item.
     * @param {object} member - The team member object from the API.
     */
    function createTeamMemberHTML(member) {
      // Use $oid for ID from json_util
      const memberId = member._id.$oid;
      // Use the placeholder if avatar_url is missing or empty
      const avatarUrl = member.avatar_url || "{{ config.ASSETS_ROOT }}/images/users/user-placeholder.jpg";
      // Provide a default role if missing
      const memberRole = member.role || "Team Member";

      // NOTE: Using placeholder avatar for now as requested
      const displayAvatarUrl = "{{ config.ASSETS_ROOT }}/images/users/user-10.jpg";

      return `
        <div class="d-flex justify-content-between align-items-center pb-2">
          <div class="d-flex align-items-center py-1 gap-2">
            <div class="avatar avatar-sm">
              <img src="${displayAvatarUrl}" alt="${member.name}" class="img-fluid rounded-circle" />
            </div>
            <div>
              <h5 class="text-nowrap mb-0 lh-base">
                <a href="/pages-profile/${memberId}" class="link-reset">${member.name}</a>
              </h5>
              <p class="text-muted fs-xxs mb-0">${memberRole}</p>
            </div>
          </div>
          <div>
            <a href="#" class="btn btn-sm btn-icon btn-default" title="Message ${member.name}">
              <i class="ti ti-message fs-lg"></i>
            </a>
            </div>
        </div>
      `;
    }

    // --- 3. FILE UPLOAD ---
    function getFileIconClass(contentType, filename) {
      const extension = filename.split(".").pop().toLowerCase();

      if (contentType.startsWith("image/")) return "ti ti-photo";
      if (contentType.startsWith("video/")) return "ti ti-video";
      if (contentType.startsWith("audio/")) return "ti ti-file-music";
      if (contentType === "application/pdf") return "ti ti-file-type-pdf";
      if (["zip", "rar", "7z", "tar", "gz"].includes(extension)) return "ti ti-file-zip";
      if (["doc", "docx"].includes(extension)) return "ti ti-file-type-doc";
      if (["xls", "xlsx"].includes(extension)) return "ti ti-file-type-xls";
      if (["ppt", "pptx"].includes(extension)) return "ti ti-file-type-ppt";
      if (
        ["js", "jsx", "ts", "tsx", "py", "java", "c", "cpp", "cs", "html", "css", "scss", "json", "xml"].includes(
          extension
        )
      )
        return "ti ti-file-code";

      return "ti ti-file-text"; // Default icon
    }

    /**
     * Formats file size into human-readable string (KB, MB).
     * @param {number} bytes - File size in bytes.
     * @returns {string} - Formatted size string.
     */
    function formatFileSize(bytes) {
      if (bytes === 0) return "0 Bytes";
      const k = 1024;
      const sizes = ["Bytes", "KB", "MB", "GB", "TB"];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + " " + sizes[i];
    }

    /**
     * Fetches the list of files for the job and renders them.
     */
    async function fetchAndRenderFiles() {
      try {
        jobFilesListContainer.innerHTML = '<div class="text-center py-2 text-muted">Loading files...</div>'; // Show loading
        const response = await fetch(`/jobs/${jobId}/files`);
        if (!response.ok) throw new Error("Failed to fetch files");

        const files = await response.json();

        jobFilesListContainer.innerHTML = ""; // Clear loading/previous

        if (files.length === 0) {
          jobFilesListContainer.innerHTML = '<p class="text-muted fs-xxs text-center py-2">No files uploaded.</p>';
        } else {
          files.forEach((file) => {
            jobFilesListContainer.innerHTML += createFileHTML(file);
          });
        }
      } catch (error) {
        console.error("Error fetching files:", error);
        jobFilesListContainer.innerHTML = '<p class="text-danger fs-xxs text-center py-2">Could not load files.</p>';
      }
    }

    /**
     * Creates the HTML for a single file item.
     * @param {object} fileData - The file metadata object from the API.
     */
    function createFileHTML(fileData) {
      const fileId = fileData._id.$oid;
      const iconClass = getFileIconClass(fileData.content_type, fileData.original_filename);
      const formattedSize = formatFileSize(fileData.size);
      const downloadUrl = `/jobs/files/${fileId}/download`; // Link to the download route

      // Optional: Add delete button later
      // <a href="#" class="btn btn-sm btn-icon btn-ghost-danger delete-file-btn" title="Delete File" data-file-id="${fileId}"><i class="ti ti-trash fs-lg"></i></a>
      const deleteButtonHTML = `
            <button type="button" class="btn btn-sm btn-icon btn-ghost-danger delete-file-btn" title="Delete File" data-file-id="${fileId}">
                <i class="ti ti-trash fs-lg"></i>
            </button>
        `;
      return `
            <div class="d-flex justify-content-between align-items-center pb-2">
              <div class="d-flex align-items-center py-1 gap-2" style="min-width: 0;">
                <div class="flex-shrink-0 avatar-md bg-light bg-opacity-50 text-muted rounded-2 d-flex align-items-center justify-content-center">
                  <i class="${iconClass} fs-xl avatar-title"></i>
                </div>
                <div class="flex-grow-1" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                  <h5 class="mb-1 fs-base"><a href="${downloadUrl}" class="link-reset" title="${fileData.original_filename}">${fileData.original_filename}</a></h5>
                  <p class="text-muted mb-0 fs-xs">${formattedSize}</p>
                </div>
              </div>
              <div class="flex-shrink-0 d-flex gap-1"> 
                <a href="${downloadUrl}" class="btn btn-sm btn-icon btn-default" title="Download">
                  <i class="ti ti-download fs-lg"></i>
                </a>
                ${deleteButtonHTML} 
              </div>
            </div>
        `;
    }

    /**
     * Uploads a single file using Fetch API.
     * @param {File} file - The file object to upload.
     */
    async function uploadFile(file) {
      const formData = new FormData();
      formData.append("file", file); // 'file' must match the key expected by Flask (request.files['file'])

      fileUploadStatusDiv.style.display = "block";
      fileUploadMessage.textContent = `Uploading ${file.name}...`;
      fileUploadProgressBar.style.width = "0%";
      fileUploadProgressBar.setAttribute("aria-valuenow", 0);

      try {
        // Note: We don't set Content-Type header when sending FormData,
        // the browser does it automatically with the correct boundary.
        const response = await fetch(`/jobs/${jobId}/files`, {
          method: "POST",
          body: formData,
          // Add progress tracking if needed (more complex)
        });

        if (!response.ok) {
          const errorData = await response
            .json()
            .catch(() => ({ error: "Upload failed with status " + response.status }));
          throw new Error(errorData.error || "Upload failed");
        }

        const newFileData = await response.json();

        // Success: Add the new file to the top of the list
        const newFileHTML = createFileHTML(newFileData);
        jobFilesListContainer.insertAdjacentHTML("afterbegin", newFileHTML);

        // If it was empty before, remove the "No files" message
        const noFilesMsg = jobFilesListContainer.querySelector("p.text-muted");
        if (noFilesMsg && noFilesMsg.textContent.includes("No files")) {
          noFilesMsg.remove();
        }

        fileUploadMessage.textContent = `Uploaded ${file.name} successfully.`;
        fileUploadProgressBar.style.width = "100%"; // Show completion briefly
        setTimeout(() => {
          fileUploadStatusDiv.style.display = "none";
        }, 2000); // Hide after 2s
      } catch (error) {
        console.error("Error uploading file:", error);
        fileUploadMessage.textContent = `Error uploading ${file.name}: ${error.message}`;
        fileUploadProgressBar.style.width = "100%"; // Indicate error visually
        fileUploadProgressBar.classList.add("bg-danger");
        // Don't hide the error immediately
        setTimeout(() => {
          fileUploadStatusDiv.style.display = "none";
          fileUploadProgressBar.classList.remove("bg-danger"); // Reset color
        }, 5000); // Hide after 5s
      } finally {
        // Reset file input to allow uploading the same file again
        jobFileInput.value = "";
      }
    }

    /**
     * Deletes a file by its ID.
     * @param {string} fileId - The ID of the file to delete.
     * @param {HTMLElement} fileElement - The DOM element representing the file item.
     */
    async function deleteFile(fileId, fileElement) {
      // Optional: Show some loading indicator on the element
      fileElement.style.opacity = "0.5";

      try {
        const response = await fetch(`/jobs/files/${fileId}`, {
          method: "DELETE",
        });

        if (!response.ok) {
          const errorData = await response
            .json()
            .catch(() => ({ error: "Delete failed with status " + response.status }));
          throw new Error(errorData.error || "Delete failed");
        }

        // Success: Remove the file element from the DOM
        fileElement.remove();

        // Optional: Show a success message (e.g., using a toast library)
        console.log(`File ${fileId} deleted successfully.`);

        // Check if the list is now empty
        if (jobFilesListContainer.children.length === 0) {
          jobFilesListContainer.innerHTML = '<p class="text-muted fs-xxs text-center py-2">No files uploaded.</p>';
        }
      } catch (error) {
        console.error("Error deleting file:", error);
        alert(`Failed to delete file: ${error.message}`);
        // Restore opacity if delete failed
        fileElement.style.opacity = "1";
      }
    }

    // Trigger hidden file input when '+' button is clicked
    addFileBtn.addEventListener("click", () => {
      jobFileInput.click();
    });

    // Handle file selection
    jobFileInput.addEventListener("change", (event) => {
      const files = event.target.files;
      if (files.length > 0) {
        // Upload each selected file
        Array.from(files).forEach((file) => {
          uploadFile(file); // Call the upload function for each file
        });
      }
    });

    // --- UNCOMMENT AND VERIFY Delete File listener ---
    jobFilesListContainer.addEventListener("click", async (e) => {
      const deleteButton = e.target.closest(".delete-file-btn");
      if (deleteButton) {
        e.preventDefault();
        const fileId = deleteButton.dataset.fileId;
        // Find the closest parent div that represents the whole file item
        const fileElement = deleteButton.closest(".d-flex.justify-content-between");
        if (confirm("Are you sure you want to delete this file?")) {
          await deleteFile(fileId, fileElement); // Pass element to remove
        }
      }
    });

    // --- 4. INITIAL LOAD ---
    fetchAndRenderComments(1, false); // Fetch page 1 and replace
    fetchAndRenderTeam(); // Fetch and render team members
    fetchAndRenderFiles(); // Fetch and render job files
  });
</script>

{% endblock page_content %}
