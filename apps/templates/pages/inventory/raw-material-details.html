{% extends 'layouts/vertical.html' %} {% block title %}Raw Material Details{% endblock title %} {% block extra_css %}
<link rel="stylesheet" href="{{ config.ASSETS_ROOT }}/plugins/daterangepicker/daterangepicker.css" type="text/css" />
<style>
  /* Custom styling for the bill link in the procurement history table */
  #procurement-history .bill-link.link-dark {
    text-decoration: underline;
    text-decoration-color: rgba(var(--bs-dark-rgb), 0.5); /* Softer underline color */
  }
  #procurement-history .bill-link.link-dark:hover {
    color: var(--bs-success) !important;
    text-decoration-color: currentColor;
  }
  /* Style for the reminder card */
  .card-reminder {
    border-left: 4px solid var(--bs-primary);
  }
  .reminder-icon {
    font-size: 2.5rem;
    color: var(--bs-primary);
  }
</style>
{% endblock extra_css %} {% block page_content %}
<div class="container-fluid">
  {% set title='Raw Material Details' %} {% set subtitle='Inventory' %} {% include 'partials/page-title.html' %}

  <div class="row justify-content-center">
    <div class="col-xxl-10">
      <div class="card">
        <div class="card-body p-4">
          <div class="d-flex">
            <div class="avatar-xxl me-3 flex-shrink-0">
              {% if material.image_id %}
              <img
                src="{{ url_for('inventory.get_raw_material_image', image_id=material.image_id) }}"
                alt="{{ material.material_name }}"
                class="img-fluid rounded"
                style="width: 100%; height: 100%; object-fit: cover"
              />
              {% else %}
              <span class="avatar-title text-bg-light rounded">
                <i class="ti ti-box text-secondary fs-2x"></i>
              </span>
              {% endif %}
            </div>
            <div class="flex-grow-1">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h3 class="mb-1 d-flex fs-xl align-items-center">{{ material.material_name }}</h3>
                  <p class="text-muted mb-2 fs-xxs">SKU: {{ material.sku }}</p>
                  <span class="badge fs-sm {{ material.stock_status.class }}">{{ material.stock_status.text }}</span>
                </div>
                <div class="ms-auto d-flex gap-3">
                  <button
                    type="button"
                    class="btn btn-soft-primary"
                    data-bs-toggle="modal"
                    data-bs-target="#reminderModal"
                  >
                    <i class="ti ti-bell-plus me-1"></i>
                    Set Reminder
                  </button>
                  <a href="#!" {# Placeholder for edit page #} class="btn btn-light">
                    <i class="ti ti-pencil me-1"></i>
                    Edit
                  </a>
                </div>
              </div>
            </div>
          </div>

          {# --- Active Reminder Card --- #} {% if active_reminder %}
          <div class="card card-reminder shadow-sm mt-4">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div class="flex-shrink-0 me-3">
                  <i class="ti ti-alarm-snooze reminder-icon"></i>
                </div>
                <div class="flex-grow-1">
                  <h5 class="mb-1">Active Reminder</h5>
                  <p class="mb-0 text-muted">
                    Order
                    <strong class="text-dark">{{ active_reminder.quantity_to_order }} {{ active_reminder.uom }}</strong>
                    by
                    <strong class="text-dark">{{ active_reminder.deadline.strftime('%d %b, %Y') }}</strong>
                    .
                  </p>
                  {% if active_reminder.notes %}
                  <small class="d-block mt-1 text-muted"><em>Notes: {{ active_reminder.notes }}</em></small>
                  {% endif %}
                </div>
                <form
                  action="{{ url_for('inventory.delete_reminder', reminder_id=active_reminder._id) }}"
                  method="POST"
                  class="d-inline ms-auto"
                  onsubmit="return confirm('Are you sure you want to dismiss this reminder?');"
                >
                  <button type="submit" class="btn btn-sm btn-light">Dismiss</button>
                </form>
              </div>
            </div>
          </div>
          {% endif %}

          <div class="row mt-4">
            <div class="col-md-3">
              <h6 class="mb-1 text-muted text-uppercase">Unit of Measure</h6>
              <p class="fw-medium mb-0">{{ material.uom }}</p>
            </div>
            <div class="col-md-3">
              <h6 class="mb-1 text-muted text-uppercase">Current Quantity</h6>
              <p class="fw-medium mb-0">{{ material.current_quantity }}</p>
            </div>
            <div class="col-md-3">
              <h6 class="mb-1 text-muted text-uppercase">Reorder Level</h6>
              <p class="fw-medium mb-0">{{ material.reorder_level }}</p>
            </div>
            <div class="col-md-3">
              <h6 class="mb-1 text-muted text-uppercase">Last Stocked On</h6>
              <p class="fw-medium mb-0">{{ material.last_stocked_on.strftime('%d %b, %Y') }}</p>
            </div>
          </div>

          <div class="row mt-4">
            <div class="col-md-6">
              <h6 class="mb-1 text-muted text-uppercase">Categories</h6>
              <div>
                {% for category in material.categories %}
                <span class="badge badge-soft-info me-1 fs-sm">{{ category }}</span>
                {% else %}
                <span class="badge badge-soft-secondary me-1 fs-sm">No Categories</span>
                {% endfor %}
              </div>
            </div>
            <div class="col-md-6">
              <h6 class="mb-1 text-muted text-uppercase">Suppliers</h6>
              <div>
                {% for supplier in material.suppliers %}
                <span class="badge badge-soft-secondary me-1 fs-sm">{{ supplier }}</span>
                {% else %}
                <span class="badge badge-soft-secondary me-1 fs-sm">No Suppliers</span>
                {% endfor %}
              </div>
            </div>
          </div>

          <hr class="my-4 border-dashed" />

          <ul class="nav nav-tabs nav-bordered mb-3" role="tablist">
            <li class="nav-item">
              <a class="nav-link active" data-bs-toggle="tab" href="#operations-usage" role="tab">
                <i class="ti ti-settings-cog fs-lg me-md-1 align-middle"></i>
                <span class="d-none d-md-inline-block align-middle">Operations Usage</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" data-bs-toggle="tab" href="#procurement-history" role="tab">
                <i class="ti ti-history fs-lg me-md-1 align-middle"></i>
                <span class="d-none d-md-inline-block align-middle">Procurement History</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" data-bs-toggle="tab" href="#description" role="tab">
                <i class="ti ti-file-text fs-lg me-md-1 align-middle"></i>
                <span class="d-none d-md-inline-block align-middle">Description</span>
              </a>
            </li>
          </ul>

          <div class="tab-content">
            <div class="tab-pane fade active show" id="operations-usage" role="tabpanel">
              <h4 class="mb-3 fs-md">Operations Using This Material</h4>
              <div class="table-responsive">
                <table class="table table-custom table-centered table-hover w-100 mb-0">
                  <thead class="bg-light align-middle bg-opacity-25 thead-sm">
                    <tr class="text-uppercase fs-xxs">
                      <th>Operation ID</th>
                      <th>Job Name</th>
                      <th>Machine Used</th>
                      <th>Quantity Used</th>
                      <th>Date</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for operation in operations_list %}
                    <tr>
                      <td>{{ operation.operation_id }}</td>
                      <td>{{ operation.job_name }}</td>
                      <td>{{ operation.machine_name }}</td>
                      <td>{{ operation.quantity_used }} {{ material.uom }}</td>
                      <td>{{ operation.start_date.strftime('%d %b, %Y') }}</td>
                    </tr>
                    {% else %}
                    <tr>
                      <td colspan="5" class="text-center text-muted py-4">
                        This raw material has not been used in any recorded operations.
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>

            <div class="tab-pane fade" id="procurement-history" role="tabpanel">
              <h4 class="mb-3 fs-md">Past Purchases</h4>
              <div class="table-responsive">
                <table class="table table-custom table-centered table-hover w-100 mb-0">
                  <thead class="bg-light align-middle bg-opacity-25 thead-sm">
                    <tr class="text-uppercase fs-xxs">
                      <th>Bill Date</th>
                      <th>Bill #</th>
                      <th>Supplier</th>
                      <th>Quantity Purchased</th>
                      <th>Unit Price</th>
                      <th>Total</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for record in procurement_history %}
                    <tr>
                      <td>{{ record.bill_date.strftime('%d %b, %Y') }}</td>
                      <td>
                        <a
                          href="{{ url_for('inventory.procurement_record_detail', record_id=record._id) }}"
                          class="link-dark fw-semibold bill-link"
                        >
                          {{ record.bill_number }}
                        </a>
                      </td>
                      <td>
                        <span class="badge badge-soft-secondary fs-xxs">{{ record.supplier_name }}</span>
                      </td>
                      <td>{{ record.item_details.quantity }} {{ material.uom }}</td>
                      <td>₹{{ "%.2f"|format(record.item_details.unit_price) }}</td>
                      <td>₹{{ "%.2f"|format(record.item_details.quantity * record.item_details.unit_price) }}</td>
                    </tr>
                    {% else %}
                    <tr>
                      <td colspan="6" class="text-center text-muted py-4">
                        No procurement history found for this material.
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>

            <div class="tab-pane fade" id="description" role="tabpanel">
              <h4 class="mb-3 fs-md">Description</h4>
              {% if material.description %}
              <div class="p-3 bg-light rounded-2">{{ material.description | safe }}</div>
              {% else %}
              <div class="text-center text-muted py-4">No description has been provided for this material.</div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Reminder Modal -->
<div class="modal fade" id="reminderModal" tabindex="-1" aria-labelledby="reminderModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="reminderModalLabel">Set Procurement Reminder</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="reminderForm">
        <div class="modal-body">
          <p class="text-muted">
            Set a manual reminder to order more
            <strong>{{ material.material_name }}</strong>
            .
          </p>
          <div class="mb-3">
            <label for="quantity_to_order" class="form-label">Quantity to Order</label>
            <div class="input-group">
              <input
                type="number"
                class="form-control"
                id="quantity_to_order"
                name="quantity_to_order"
                placeholder="e.g., 500"
                required
              />
              <span class="input-group-text">{{ material.uom }}</span>
            </div>
          </div>
          <div class="mb-3">
            <label for="deadline" class="form-label">Order Deadline</label>
            <input
              type="text"
              id="deadline"
              name="deadline"
              class="form-control"
              data-provider="flatpickr"
              data-date-format="Y-m-d"
              placeholder="Select Date"
              required
            />
          </div>
          <div class="mb-3">
            <label for="notes" class="form-label">Notes (Optional)</label>
            <textarea
              class="form-control"
              id="notes"
              name="notes"
              rows="3"
              placeholder="e.g., Check for new suppliers"
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary">Set Reminder</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock page_content %} {% block extra_javascript %}
<script src="{{ config.ASSETS_ROOT }}/plugins/moment/moment.min.js"></script>
<script src="{{ config.ASSETS_ROOT }}/plugins/daterangepicker/daterangepicker.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Initialize the date picker inside the modal
    $("#deadline")
      .daterangepicker({
        singleDatePicker: true,
        autoUpdateInput: false,
        minDate: new Date(),
        locale: {
          format: "YYYY-MM-DD",
        },
      })
      .on("apply.daterangepicker", function (ev, picker) {
        $(this).val(picker.startDate.format("YYYY-MM-DD"));
      });

    // Handle form submission
    const reminderForm = document.getElementById("reminderForm");
    reminderForm.addEventListener("submit", function (event) {
      event.preventDefault();

      const formData = new FormData(reminderForm);
      const url = "{{ url_for('inventory.set_raw_material_reminder', material_id=material._id) }}";

      fetch(url, {
        method: "POST",
        body: formData,
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            // Reload the page to show the flash message and the new reminder card
            window.location.reload();
          } else {
            // You can implement a more robust error display here (e.g., a toast notification)
            alert("Error: " + data.error);
          }
        })
        .catch((error) => {
          console.error("Error:", error);
          alert("An unexpected error occurred. Please try again.");
        });
    });
  });
</script>
{% endblock extra_javascript %}
