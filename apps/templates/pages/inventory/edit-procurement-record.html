{% extends 'layouts/vertical.html' %} {% block title %}Edit Procurement Record{% endblock title %} {% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet" />
<link rel="stylesheet" href="{{ config.ASSETS_ROOT }}/plugins/daterangepicker/daterangepicker.css" type="text/css" />
<style>
  /* Tom Select integration styles */
  .ts-control {
    padding: 0.4375rem 0.875rem; /* Match .form-control padding */
  }
  .ts-dropdown {
    z-index: 1060 !important;
    background-color: #fff !important;
    border: 1px solid #dee2e6 !important;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
  }
  .ts-dropdown .option:hover,
  .ts-dropdown .option.active {
    background-color: #f8f9fa !important;
    color: #212529 !important;
  }

  /* Custom styling for the remove item button */
  .remove-item-btn {
    width: 32px;
    height: 32px;
    padding: 0;
    line-height: 30px;
    font-size: 1.4rem;
    font-weight: 600;
  }
  .remove-item-btn:hover {
    background-color: #d03f54 !important;
  }

  .form-control-sm {
    height: 40px;
  }
</style>
{% endblock extra_css %} {% block page_content %}

<div class="container-fluid">
  {% set title='Edit Procurement Record' %} {% set subtitle='Inventory' %} {% include 'partials/page-title.html' %}

  <div class="row justify-content-center">
    <div class="col-xxl-8">
      <div class="card">
        <form id="editProcurementForm" method="POST" enctype="multipart/form-data" novalidate>
          <div class="card-body p-4">
            <!-- Bill Details Header -->
            <div class="row">
              <div class="col-lg-4">
                <div class="mb-3">
                  <label for="supplierName" class="form-label">Supplier</label>
                  <select id="supplierName" name="supplier_name" class="form-select" required>
                    <option value="" disabled>Select a supplier</option>
                    {% for supplier in all_suppliers %} {% if supplier == record.supplier_name %}
                    <option value="{{ supplier }}" selected>{{ supplier }}</option>
                    {% else %}
                    <option value="{{ supplier }}">{{ supplier }}</option>
                    {% endif %} {% endfor %}
                  </select>
                  <div class="invalid-feedback">Please select a supplier.</div>
                </div>
              </div>
              <div class="col-lg-4">
                <div class="mb-3">
                  <label for="billNumber" class="form-label">Bill / Invoice #</label>
                  <input
                    type="text"
                    id="billNumber"
                    name="bill_number"
                    class="form-control"
                    value="{{ record.bill_number }}"
                    required
                  />
                  <div class="invalid-feedback">Please enter the bill number.</div>
                </div>
              </div>
              <div class="col-lg-4">
                <div class="mb-3">
                  <label for="billDate" class="form-label">Bill Date</label>
                  <input
                    type="text"
                    id="billDate"
                    name="bill_date"
                    class="form-control"
                    data-provider="flatpickr"
                    data-date-format="Y-m-d"
                    data-toggle="date-picker"
                    data-single-date-picker="true"
                    data-locale="{'format': 'YYYY-MM-DD'}"
                    value="{{ record.bill_date_str }}"
                    required
                  />
                  <div class="invalid-feedback">Please select the bill date.</div>
                </div>
              </div>
            </div>

            <!-- Items Table -->
            <div class="table-responsive mt-3">
              <h5 class="fw-semibold mb-3">Purchased Materials</h5>
              <table class="table table-bordered table-nowrap align-middle">
                <thead class="bg-light align-middle bg-opacity-25 thead-sm">
                  <tr class="text-uppercase fs-xxs">
                    <th style="width: 40%">Material</th>
                    <th style="width: 15%">Quantity</th>
                    <th style="width: 15%">Unit</th>
                    <th style="width: 15%">Unit Price</th>
                    <th style="width: 15%">Total</th>
                    <th style="width: 5%" class="text-center">
                      <i class="ti ti-trash"></i>
                    </th>
                  </tr>
                </thead>
                <tbody id="stock-items">
                  <!-- Item rows will be added here by JavaScript -->
                </tbody>
              </table>
              <button type="button" id="addItemBtn" class="btn btn-soft-primary mt-2">
                <i class="ti ti-plus"></i>
                Add Material
              </button>
            </div>

            <!-- Notes & Totals -->
            <div class="row mt-4 d-flex align-items-stretch">
              <div class="col-lg-8 d-flex flex-column">
                <div class="mb-3 flex-grow-1 d-flex flex-column">
                  <label for="notes" class="form-label">Notes</label>
                  <textarea id="notes" name="notes" class="form-control flex-grow-1" placeholder="Add any notes...">
                    {{- record.notes or '' -}}
                  </textarea>
                </div>
              </div>
              <div class="col-lg-4">
                <div class="card bg-light bg-opacity-50 shadow-none h-100">
                  <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                      <span class="fw-medium">Subtotal:</span>
                      <span id="subtotal" class="fw-medium">₹0.00</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                      <span>Taxes / Fees:</span>
                      <input
                        type="number"
                        id="taxes"
                        class="form-control form-control-sm text-end"
                        style="width: 100px"
                        value="0"
                        step="any"
                      />
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                      <span>Discount:</span>
                      <input
                        type="number"
                        id="discount"
                        class="form-control form-control-sm text-end"
                        style="width: 100px"
                        value="0"
                        step="any"
                      />
                    </div>
                    <div class="border-top border-dashed my-2"></div>
                    <div class="d-flex justify-content-between">
                      <h5 class="mb-0">Grand Total:</h5>
                      <h5 id="grandTotal" class="mb-0">₹0.00</h5>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Hidden input to store item data -->
            <input type="hidden" name="items_data" id="itemsData" />

            <!-- Submit Button -->
            <div class="d-flex justify-content-end mt-4 gap-2">
              <a
                href="{{ url_for('inventory.procurement_record_detail', record_id=record._id) }}"
                class="btn btn-light"
              >
                Cancel
              </a>
              <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
          </div>
        </form>
      </div>
      <!-- end card-->
    </div>
  </div>
  <!-- end row-->
</div>
<!-- container -->

{% endblock page_content %} {% block extra_javascript %}
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
<script src="{{ config.ASSETS_ROOT }}/plugins/moment/moment.min.js"></script>
<script src="{{ config.ASSETS_ROOT }}/plugins/daterangepicker/daterangepicker.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // --- Initialize Tom Select for Supplier ---
    const supplierSelect = document.getElementById("supplierName");
    if (supplierSelect) {
      new TomSelect(supplierSelect, { dropdownParent: "body" });
    }

    // === Initialize Daterangepickers ===
    const datePickers = document.querySelectorAll('[data-toggle="date-picker"]');
    datePickers.forEach(function (picker) {
      let config = {
        singleDatePicker: true,
        autoUpdateInput: false,
        locale: { format: "YYYY-MM-DD", cancelLabel: "Clear" },
      };
      if (picker.dataset.locale) {
        try {
          const localeSettings = JSON.parse(picker.dataset.locale.replace(/'/g, '"'));
          if (localeSettings.format) config.locale.format = localeSettings.format;
        } catch (e) {
          console.warn("Could not parse data-locale attribute:", e);
        }
      }
      $(picker).daterangepicker(config);
      $(picker).on("apply.daterangepicker", function (ev, picker) {
        $(this).val(picker.startDate.format(config.locale.format));
      });
      $(picker).on("cancel.daterangepicker", function (ev, picker) {
        $(this).val("");
      });
    });

    // --- Data & State ---
    const allMaterials = {{ all_materials_json | safe }};
    const initialItems = {{ record.procurement_items | tojson | safe }};
    const stockItemsContainer = document.getElementById("stock-items");
    const addItemBtn = document.getElementById("addItemBtn");
    let tomSelectInstances = [];

    // --- Functions ---
    const createItemRow = (item = null) => {
      const rowId = `item-row-${Date.now()}`;
      const newRow = document.createElement("tr");
      newRow.id = rowId;
      newRow.classList.add("item-row");
      newRow.innerHTML = `
        <td>
          <select class="form-select material-select" required>
            <option value="">Search material...</option>
            ${allMaterials.map(m => `<option value="${m._id}" data-uom="${m.uom}">${m.material_name} (${m.sku})</option>`).join("")}
          </select>
        </td>
        <td><input type="number" class="form-control form-control-sm quantity" placeholder="0" min="0" step="any" required></td>
        <td><input type="text" class="form-control form-control-sm uom" readonly></td>
        <td><input type="number" class="form-control form-control-sm unit-price" placeholder="0.00" min="0" step="any" required></td>
        <td><input type="text" class="form-control form-control-sm total-price" readonly></td>
        <td class="text-center align-middle"><button type="button" class="btn btn-sm btn-danger remove-item-btn">×</button></td>
      `;
      stockItemsContainer.appendChild(newRow);

      const selectEl = newRow.querySelector(".material-select");
      const tomSelect = new TomSelect(selectEl, {
        create: false,
        dropdownParent: "body",
      });
      tomSelectInstances.push({ id: rowId, instance: tomSelect });

      tomSelect.on("change", (value) => {
        const material = allMaterials.find((m) => m._id === value);
        newRow.querySelector(".uom").value = material ? material.uom : "";
        updateTotals();
      });

      // If initial item data is provided, populate the row
      if (item) {
        tomSelect.setValue(item.material_id);
        newRow.querySelector(".quantity").value = item.quantity;
        newRow.querySelector(".unit-price").value = item.unit_price;
      }
    };

    const updateTotals = () => {
      let subtotal = 0;
      document.querySelectorAll(".item-row").forEach((row) => {
        const quantity = parseFloat(row.querySelector(".quantity").value) || 0;
        const unitPrice = parseFloat(row.querySelector(".unit-price").value) || 0;
        const totalPrice = quantity * unitPrice;
        row.querySelector(".total-price").value = totalPrice.toFixed(2);
        subtotal += totalPrice;
      });

      const taxes = parseFloat(document.getElementById("taxes").value) || 0;
      const discount = parseFloat(document.getElementById("discount").value) || 0;
      const grandTotal = subtotal + taxes - discount;

      document.getElementById("subtotal").textContent = `₹${subtotal.toFixed(2)}`;
      document.getElementById("grandTotal").textContent = `₹${grandTotal.toFixed(2)}`;
    };

    // --- Event Listeners ---
    addItemBtn.addEventListener("click", () => createItemRow());

    stockItemsContainer.addEventListener("click", (e) => {
      if (e.target.classList.contains("remove-item-btn")) {
        const row = e.target.closest("tr");
        const tomSelect = tomSelectInstances.find((ts) => ts.id === row.id);
        if (tomSelect) tomSelect.instance.destroy();
        tomSelectInstances = tomSelectInstances.filter((ts) => ts.id !== row.id);
        row.remove();
        updateTotals();
      }
    });

    stockItemsContainer.addEventListener("input", (e) => {
      if (e.target.classList.contains("quantity") || e.target.classList.contains("unit-price")) {
        updateTotals();
      }
    });

    document.getElementById("taxes").addEventListener("input", updateTotals);
    document.getElementById("discount").addEventListener("input", updateTotals);

    // --- Form Submission ---
    const form = document.getElementById("editProcurementForm");
    form.addEventListener("submit", function (event) {
      event.preventDefault();

      let itemsData = [];
      let isItemsValid = true;
      document.querySelectorAll(".item-row").forEach((row) => {
        const materialId = row.querySelector(".material-select").value;
        const quantity = row.querySelector(".quantity").value;
        const unitPrice = row.querySelector(".unit-price").value;

        if (!materialId || !quantity || !unitPrice || parseFloat(quantity) <= 0) {
          isItemsValid = false;
        }

        itemsData.push({
          material_id: materialId,
          quantity: parseFloat(quantity),
          unit_price: parseFloat(unitPrice),
        });
      });

      if (itemsData.length === 0) {
        alert("Please add at least one material to the list.");
        isItemsValid = false;
      }

      document.getElementById("itemsData").value = JSON.stringify(itemsData);

      if (!form.checkValidity() || !isItemsValid) {
        event.stopPropagation();
        alert("Please fill out all required fields and ensure all items have a material, quantity, and price.");
      } else {
        form.submit();
      }

      form.classList.add("was-validated");
    });

    // --- Initial State ---
    if (initialItems.length > 0) {
      initialItems.forEach((item) => createItemRow(item));
    } else {
      createItemRow();
    }
    updateTotals();
  });
</script>

{% endblock extra_javascript %}
